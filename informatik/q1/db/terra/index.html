<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Übungen - Terra Datenbank</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        :root {
            --bg-body: #fdfcfc;
            --bg-surface: #ffffff;
            --text-main: #334155;
            --text-muted: #64748b;
            --primary: #7dd3fc;
            --primary-dark: #0ea5e9;
            --primary-bg: #f0f9ff;
            --accent: #818cf8;
            --border-color: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --success-bg: #dcfce7;
            --success-text: #166534;
            --success-border: #86efac;
            --error-bg: #fee2e2;
            --error-text: #991b1b;
            --error-border: #fca5a5;
            --warning-bg: #fff7ed;
            --warning-text: #9a3412;
            --warning-border: #fdba74;
            --code-font: 'Source Code Pro', monospace;
            --body-font: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--body-font);
            background: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-surface);
            box-shadow: var(--shadow-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .header-top {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .header-content h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            letter-spacing: -0.025em;
            margin: 0;
        }
        
        .subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 0;
        }

        .header-nav {
            background: var(--bg-surface);
            padding: 0.5rem 0;
        }

        .nav-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        nav {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            margin: 0;
            padding: 0;
        }
        
        nav button {
            background: transparent;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        nav button:hover { background: #f1f5f9; color: var(--text-main); }
        
        nav button.active {
            background: var(--primary-bg);
            color: var(--primary-dark);
            font-weight: 600;
        }

        .file-upload-btn {
            background: var(--bg-surface);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .file-upload-btn:hover {
            background: var(--primary-bg);
            color: var(--primary-dark);
            border-color: var(--primary);
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        #db-status {
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            background: var(--bg-surface);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .stats span { font-weight: 600; color: var(--text-main); }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .section {
            background: var(--bg-surface);
            padding: 2rem;
            margin-bottom: 1.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        
        .section h2 {
            font-size: 1.25rem;
            margin-bottom: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .section h3 {
            font-size: 1rem;
            margin: 1.5rem 0 0.75rem 0;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            font-family: var(--code-font);
            font-size: 0.9rem;
            border: 2px solid #1e293b;
            border-radius: 8px;
            background: #1e293b;
            color: #e2e8f0;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        textarea:focus { outline: none; border-color: var(--primary-dark); box-shadow: 0 0 0 3px rgba(14,165,233,0.15); }
        textarea::placeholder { color: #64748b; }

        /* Playground editor: lighter theme */
        #main-editor { background: #f8fafc; color: #334155; border-color: var(--border-color); }
        #main-editor:focus { border-color: var(--primary); background: #fff; box-shadow: none; }
        #main-editor::placeholder { color: #94a3b8; }
        
        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        button {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            background: #fff;
            border: 1px solid #cbd5e1;
            cursor: pointer;
            font-family: inherit;
            border-radius: 6px;
            font-weight: 500;
            color: #475569;
            transition: all 0.2s;
        }
        
        button:hover { background: #f8fafc; border-color: #94a3b8; }
        button:active { transform: translateY(1px); }
        
        .btn-primary {
            background: #3b82f6;
            color: #fff;
            border: none;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover { background: #2563eb; border-color: transparent; }
        
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 0.5rem;
            background: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 400px;
        }
        
        th {
            text-align: left;
            padding: 0.85rem 1rem;
            background: #f1f5f9;
            color: #475569;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
            vertical-align: top;
        }
        
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background-color: #fafbfc; }
        tr:hover td { background-color: #f0f9ff; }
        
        .message {
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        
        .success { background: var(--success-bg); color: var(--success-text); border: 1px solid var(--success-border); }
        .error { background: var(--error-bg); color: var(--error-text); border: 1px solid var(--error-border); }
        .warning { background: var(--warning-bg); color: var(--warning-text); border: 1px solid var(--warning-border); }
        
        /* Niveau color coding */
        .niveau-0 { --nv-color: #3b82f6; --nv-bg: #eff6ff; --nv-border: #bfdbfe; }
        .niveau-1 { --nv-color: #8b5cf6; --nv-bg: #f5f3ff; --nv-border: #c4b5fd; }
        .niveau-2 { --nv-color: #d97706; --nv-bg: #fffbeb; --nv-border: #fcd34d; }
        .niveau-3a { --nv-color: #059669; --nv-bg: #ecfdf5; --nv-border: #6ee7b7; }
        .niveau-3b { --nv-color: #0891b2; --nv-bg: #ecfeff; --nv-border: #67e8f9; }
        .niveau-4 { --nv-color: #dc2626; --nv-bg: #fef2f2; --nv-border: #fca5a5; }

        .section.niveau-section { border-left: 4px solid var(--nv-color); }
        .section.niveau-section h2 { color: var(--nv-color); }

        .section .niveau-progress {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .section .niveau-progress .progress-bar {
            flex: 1;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .section .niveau-progress .progress-fill {
            height: 100%;
            background: var(--nv-color);
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        .section .niveau-progress .progress-text {
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            color: var(--nv-color);
        }

        .task {
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: #fff;
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .task:hover { box-shadow: var(--shadow-sm); }
        
        .task.solved { background: #f8fdf9; border-color: #d1fae5; }

        .task.solved .task-body { display: none; }
        .task.solved.expanded .task-body { display: block; }

        .task.solved .task-header { cursor: pointer; margin-bottom: 0; user-select: none; }
        .task.solved.expanded .task-header { margin-bottom: 0.75rem; }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .task-header .expand-hint {
            display: none;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-left: 0.5rem;
        }

        .task.solved:not(.expanded) .expand-hint { display: inline; }
        
        .task-title { font-weight: 600; font-size: 1.05rem; color: #1e293b; }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            background: var(--nv-bg, #f1f5f9);
            border: 1px solid var(--nv-border, #e2e8f0);
            border-radius: 999px;
            font-weight: 600;
            color: var(--nv-color, #64748b);
        }
        
        .badge.solved { background: #dcfce7; color: #15803d; border-color: #86efac; }
        
        .task-desc {
            color: #475569;
            font-size: 0.95rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .hint {
            background: #fffbeb;
            border: 1px solid #fef3c7;
            color: #92400e;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
            font-size: 0.9rem;
            border-radius: 8px;
        }
        
        .hint.visible { display: block; animation: fadeIn 0.3s; }
        
        .help-block {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
        }
        
        .help-block h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        
        .help-block code {
            display: block;
            font-family: var(--code-font);
            font-size: 0.85rem;
            background: #fff;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            white-space: pre;
            overflow-x: auto;
            color: #0f172a;
        }
        
        code.inline {
            font-family: var(--code-font);
            background: #f1f5f9;
            padding: 0.1rem 0.3rem;
            font-size: 0.9em;
            border-radius: 4px;
            color: #0f172a;
        }
        
        .result-info {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0.5rem 0 0.25rem 0;
            font-family: var(--code-font);
        }

        .result-label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.25rem;
            color: #475569;
        }

        .expected-block {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .expected-block .result-label {
            color: var(--primary-dark);
            margin-top: 0;
        }

        .expected-block .table-wrapper {
            border-color: #bae6fd;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div class="sticky-header">
        <div class="header-top">
            <div class="header-content">
                <h1>SQL Übungen - Terra Datenbank</h1>
                <p class="subtitle">SELECT, WHERE, Aggregation, GROUP BY & JOINs</p>
            </div>
            <div>
                <input type="file" id="local-file-input" accept=".db,.sqlite,.sqlite3" style="display: none;" onchange="loadLocalFile(this)">
                <button class="file-upload-btn" onclick="document.getElementById('local-file-input').click()">
                    Lokale Datei öffnen
                </button>
            </div>
        </div>
        <div class="header-nav">
            <div class="nav-container">
                <nav>
                    <button class="active" onclick="switchTab('editor')">Freier Editor</button>
                    <button onclick="switchTab('tasks')">Aufgaben</button>
                    <button onclick="switchTab('database')">Datenbank Struktur</button>
                    <button onclick="switchTab('help')">Cheat Sheet</button>
                </nav>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div id="db-status"></div>
        
        <div id="tab-editor" class="tab-content active">
            <div class="section">
                <h2>SQL Playground</h2>
                <p style="margin-bottom: 1rem; color: var(--text-muted);">Teste hier deine eigenen Abfragen gegen die Terra-Datenbank.</p>
                <textarea id="main-editor" placeholder="SELECT * FROM BERG ORDER BY HOEHE DESC LIMIT 10;">SELECT * FROM LAND LIMIT 10;</textarea>
                <div class="button-group">
                    <button class="btn-primary" onclick="runMain()">Abfrage Ausführen</button>
                    <button onclick="clearMain()">Leeren</button>
                </div>
                <h3 id="main-result-header" style="display:none; margin-top: 1.5rem; font-size: 1rem; color: var(--text-muted);">Ergebnis:</h3>
                <div id="main-result"></div>
            </div>
        </div>
        
        <div id="tab-tasks" class="tab-content">
            <div class="stats">
                <div>Gelöst: <span id="solved">0</span>/<span id="total">0</span></div>
                <div>Fortschritt: <span id="progress">0%</span></div>
            </div>
            <div id="tasks"></div>
            <div class="section">
                <h2>Lösungen Speichern</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">Exportiere deine Lösungen als Markdown-Datei für deine Unterlagen.</p>
                <button class="btn-primary" onclick="exportSolutions()">Lösungen herunterladen</button>
            </div>
        </div>
        
        <div id="tab-database" class="tab-content">
            <div class="section">
                <h2>Datenbank-Übersicht</h2>
                
                <h3>Haupttabellen</h3>
                
                <div class="help-block">
                    <h4>BERG</h4>
                    <code>B_NAME       varchar(20)   - Bergname
GEBIRGE      varchar(25)   - Gebirgsname
HOEHE        double        - Höhe in Metern
JAHR         int           - Jahr der Erstbesteigung
LAENGE       double        - Längengrad
BREITE       double        - Breitengrad</code>
                </div>
                
                <div class="help-block">
                    <h4>LAND</h4>
                    <code>L_ID         varchar(4)    - Länder-ID (PK)
L_NAME       varchar(50)   - Landesname
EINWOHNER    double        - Einwohnerzahl
FLAECHE      double        - Fläche in km²
HAUPTSTADT   varchar(25)   - Hauptstadt
LT_ID        varchar(4)    - Landteil-ID</code>
                </div>

                <div class="help-block">
                    <h4>LANDTEIL</h4>
                    <code>id           int           - ID (PK)
LT_ID        varchar(4)    - Landteil-ID
L_ID         varchar(4)    - Länder-ID
LT_NAME      varchar(50)   - Name des Landesteils
EINWOHNER    double        - Einwohnerzahl
LAGE         char(2)       - Lage
HAUPTSTADT   varchar(25)   - Hauptstadt</code>
                </div>
                
                <div class="help-block">
                    <h4>STADT</h4>
                    <code>ST_NAME      varchar(25)   - Stadtname (PK)
L_ID         varchar(4)    - Länder-ID
LT_ID        varchar(4)    - Landteil-ID
EINWOHNER    int           - Einwohnerzahl
BREITE       double        - Breitengrad
LAENGE       double        - Längengrad</code>
                </div>

                <div class="help-block">
                    <h4>FLUSS</h4>
                    <code>F_NAME       varchar(20)   - Flussname (PK)
FLUSS        varchar(20)   - Quellfluss
SEE          varchar(25)   - Mündet in See
MEER         varchar(25)   - Mündet in Meer
LAENGE       int           - Länge in km
LAENGEU      double        - Längengrad Ursprung
BREITEU      double        - Breitengrad Ursprung
LAENGEM      double        - Längengrad Mündung
BREITEM      double        - Breitengrad Mündung</code>
                </div>

                <div class="help-block">
                    <h4>SEE</h4>
                    <code>S_NAME       varchar(25)   - Seename
TIEFE        double        - Tiefe in Metern
FLAECHE      double        - Fläche in km²</code>
                </div>

                <div class="help-block">
                    <h4>MEER</h4>
                    <code>M_NAME       varchar(25)   - Meeresname (PK)
TIEFE        double        - Tiefe in Metern</code>
                </div>

                <div class="help-block">
                    <h4>INSEL</h4>
                    <code>I_NAME       varchar(25)   - Inselname (PK)
INSELGRUPPE  varchar(25)   - Inselgruppe
FLAECHE      double        - Fläche in km²
LAENGE       double        - Längengrad
BREITE       double        - Breitengrad</code>
                </div>

                <div class="help-block">
                    <h4>WUESTE</h4>
                    <code>id           int           - ID (PK)
W_NAME       varchar(25)   - Wüstenname
FLAECHE      double        - Fläche in km²
WUESTENART   varchar(17)   - Art der Wüste</code>
                </div>

                <div class="help-block">
                    <h4>EBENE</h4>
                    <code>E_NAME       varchar(25)   - Ebenenname
HOEHE        double        - Höhe in Metern
FLAECHE      double        - Fläche in km²</code>
                </div>

                <div class="help-block">
                    <h4>KONTINENT</h4>
                    <code>K_NAME       varchar(10)   - Kontinentname (PK)
FLAECHE      double        - Fläche in km²</code>
                </div>

                <div class="help-block">
                    <h4>ORGANISATION</h4>
                    <code>id           int           - ID (PK)
O_NAME       varchar(70)   - Name der Organisation
ABKUERZUNG   varchar(20)   - Abkürzung</code>
                </div>
                
                <h3>Verbindungstabellen (für JOINs)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div class="help-block">
                        <h4>GEO_BERG</h4>
                        <code>id           int           - ID (PK)
L_ID         varchar(4)    - Länder-ID
LT_ID        varchar(4)    - Landteil-ID
B_NAME       varchar(20)   - Bergname

Verbindet: LAND ↔ BERG</code>
                    </div>
                    
                    <div class="help-block">
                        <h4>GEO_FLUSS</h4>
                        <code>id           int           - ID (PK)
L_ID         varchar(4)    - Länder-ID
LT_ID        varchar(50)   - Landteil-ID
F_NAME       varchar(20)   - Flussname

Verbindet: LAND ↔ FLUSS</code>
                    </div>

                    <div class="help-block">
                        <h4>GEO_SEE</h4>
                        <code>id           int           - ID (PK)
LT_ID        varchar(4)    - Landteil-ID
L_ID         varchar(4)    - Länder-ID
S_NAME       varchar(25)   - Seename

Verbindet: LAND ↔ SEE</code>
                    </div>

                    <div class="help-block">
                        <h4>GEO_MEER</h4>
                        <code>id           int           - ID (PK)
LT_ID        varchar(4)    - Landteil-ID
L_ID         varchar(4)    - Länder-ID
M_NAME       varchar(25)   - Meeresname

Verbindet: LAND ↔ MEER</code>
                    </div>

                    <div class="help-block">
                        <h4>GEO_INSEL</h4>
                        <code>LT_ID        varchar(4)    - Landteil-ID
L_ID         varchar(4)    - Länder-ID
I_NAME       varchar(25)   - Inselname

Verbindet: LAND ↔ INSEL</code>
                    </div>

                    <div class="help-block">
                        <h4>GEO_WUESTE</h4>
                        <code>LT_ID        varchar(4)    - Landteil-ID
L_ID         varchar(4)    - Länder-ID
W_NAME       varchar(25)   - Wüstenname

Verbindet: LAND ↔ WUESTE</code>
                    </div>

                    <div class="help-block">
                        <h4>GEO_EBENE</h4>
                        <code>LT_ID        varchar(4)    - Landteil-ID
L_ID         varchar(4)    - Länder-ID
E_NAME       varchar(25)   - Ebenenname

Verbindet: LAND ↔ EBENE</code>
                    </div>
                    
                    <div class="help-block">
                        <h4>UMFASST</h4>
                        <code>id           int           - ID (PK)
L_ID         varchar(4)    - Länder-ID
K_NAME       varchar(10)   - Kontinent
PROZENT      double        - Anteil in %

Verbindet: LAND ↔ KONTINENT</code>
                    </div>

                    <div class="help-block">
                        <h4>LIEGT_AN</h4>
                        <code>id           int           - ID (PK)
ST_NAME      varchar(25)   - Stadtname
LT_ID        varchar(4)    - Landteil-ID
L_ID         varchar(4)    - Länder-ID
F_NAME       varchar(20)   - Fluss
S_NAME       varchar(25)   - See
M_NAME       varchar(25)   - Meer

Verbindet: STADT ↔ FLUSS/SEE/MEER</code>
                    </div>

                    <div class="help-block">
                        <h4>IST_BENACHBART_ZU</h4>
                        <code>id           int           - ID (PK)
LAND1        varchar(4)    - Länder-ID 1
LAND2        varchar(4)    - Länder-ID 2

Verbindet: LAND ↔ LAND</code>
                    </div>

                    <div class="help-block">
                        <h4>IST_MITGLIED_VON</h4>
                        <code>L_ID         varchar(4)    - Länder-ID
ABKUERZUNG   varchar(20)   - Organisations-Abk.
ART          varchar(25)   - Mitgliedschaftsart

Verbindet: LAND ↔ ORGANISATION</code>
                    </div>

                    <div class="help-block">
                        <h4>HAT_SITZ_IN</h4>
                        <code>ST_NAME      varchar(25)   - Stadtname
LT_ID        varchar(4)    - Landteil-ID
L_ID         varchar(4)    - Länder-ID
ABKUERZUNG   varchar(20)   - Organisations-Abk.

Verbindet: STADT ↔ ORGANISATION</code>
                    </div>

                    <div class="help-block">
                        <h4>GEHT_UEBER_IN</h4>
                        <code>MEER1        varchar(25)   - Meer 1
MEER2        varchar(25)   - Meer 2

Verbindet: MEER ↔ MEER</code>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tab-help" class="tab-content">
            <div class="section">
                <h2>SQL Referenz</h2>
                
                <h3>Aggregation</h3>
                <div class="help-block">
                    <h4>COUNT, MAX, MIN, AVG</h4>
                    <code>SELECT COUNT(*) FROM LAND;
SELECT MAX(HOEHE) FROM BERG;
SELECT AVG(FLAECHE) FROM LAND;</code>
                </div>
                
                <h3>Gruppierung</h3>
                <div class="help-block">
                    <h4>GROUP BY & HAVING</h4>
                    <code>SELECT GEBIRGE, COUNT(*)
FROM BERG
GROUP BY GEBIRGE
HAVING COUNT(*) > 5;</code>
                </div>
                
                <h3>Verknüpfung (JOINs)</h3>
                <div class="help-block">
                    <h4>Einfacher JOIN (2 Tabellen)</h4>
                    <code>-- STADT und LAND teilen sich L_ID
SELECT s.ST_NAME, l.L_NAME
FROM STADT s
JOIN LAND l ON s.L_ID = l.L_ID;</code>
                </div>
                <div class="help-block">
                    <h4>JOIN über Verbindungstabelle (3 Tabellen)</h4>
                    <code>-- BERG hat keine L_ID → Umweg über GEO_BERG
SELECT b.B_NAME, l.L_NAME
FROM BERG b
JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME
JOIN LAND l ON gb.L_ID = l.L_ID;</code>
                </div>
            </div>
        </div>

        <div style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-muted);">
            <button onclick="resetApp()" style="background: #fff; color: #64748b; border: 1px solid #cbd5e1; font-size: 0.8rem; padding: 0.5rem 1rem;">
                Cache leeren & App zurücksetzen
            </button>
        </div>
    </div>
    
    <script>
        let db;

        // Niveau order and labels
        const niveauOrder = ['0','1','2','3a','3b','4'];
        const niveauLabels = {
            '0': 'Einstieg (SELECT & WHERE)',
            '1': 'Aggregation',
            '2': 'GROUP BY & HAVING',
            '3a': 'Einfache JOINs (2 Tabellen)',
            '3b': 'JOINs mit Verbindungstabellen',
            '4': 'Kombination'
        };

        const tasks = [
            // =====================================================
            // Niveau 0: Einstieg (SELECT, WHERE, ORDER BY, LIMIT)
            // =====================================================
            { id: 'n0-1', n: '0', title: 'Alle Berge anzeigen', desc: 'Zeige alle Berge mit allen Spalten an!', hint: 'SELECT * FROM ...', sol: 'SELECT * FROM BERG' },
            { id: 'n0-2', n: '0', title: 'Alle L\u00e4nder', desc: 'Zeige alle L\u00e4nder mit Name und Hauptstadt an!', hint: 'SELECT spalte1, spalte2 FROM ...', sol: 'SELECT L_NAME, HAUPTSTADT FROM LAND' },
            { id: 'n0-3', n: '0', title: 'Wo liegt Berlin?', desc: 'Zeige Breitengrad und L\u00e4ngengrad von Berlin! (Tabelle: STADT)', hint: 'WHERE ST_NAME = \'Berlin\'', sol: 'SELECT ST_NAME, BREITE, LAENGE FROM STADT WHERE ST_NAME = \'Berlin\'' },
            { id: 'n0-4', n: '0', title: 'Top 5 h\u00f6chste Berge', desc: 'Zeige die 5 h\u00f6chsten Berge (Name und H\u00f6he), absteigend sortiert!', hint: 'ORDER BY ... DESC und LIMIT', sol: 'SELECT B_NAME, HOEHE FROM BERG ORDER BY HOEHE DESC LIMIT 5' },
            { id: 'n0-5', n: '0', title: 'Achttausender', desc: 'Welche Berge sind h\u00f6her als 8000 Meter? Zeige Name und H\u00f6he!', hint: 'WHERE HOEHE > 8000', sol: 'SELECT B_NAME, HOEHE FROM BERG WHERE HOEHE > 8000 ORDER BY HOEHE DESC' },
            { id: 'n0-6', n: '0', title: 'Berge im Himalaya', desc: 'Zeige alle Berge, die im Himalaya liegen!', hint: 'WHERE GEBIRGE = \'Himalaya\'', sol: 'SELECT * FROM BERG WHERE GEBIRGE = \'Himalaya\'' },
            { id: 'n0-7', n: '0', title: 'Mount-Berge', desc: 'Finde alle Berge, deren Name mit "Mount" beginnt!', hint: 'LIKE \'Mount%\'', sol: 'SELECT B_NAME, HOEHE FROM BERG WHERE B_NAME LIKE \'Mount%\'' },
            { id: 'n0-8', n: '0', title: 'Gro\u00dfe L\u00e4nder', desc: 'Welche L\u00e4nder haben mehr als 100 Millionen Einwohner? Sortiere absteigend!', hint: 'WHERE EINWOHNER > 100000000 und ORDER BY', sol: 'SELECT L_NAME, EINWOHNER FROM LAND WHERE EINWOHNER > 100000000 ORDER BY EINWOHNER DESC' },
            { id: 'n0-9', n: '0', title: 'Lange Fl\u00fcsse', desc: 'Welche Fl\u00fcsse sind l\u00e4nger als 5000 km? Zeige Name und L\u00e4nge!', hint: 'WHERE LAENGE > 5000', sol: 'SELECT F_NAME, LAENGE FROM FLUSS WHERE LAENGE > 5000 ORDER BY LAENGE DESC' },
            { id: 'n0-10', n: '0', title: 'St\u00e4dte in Deutschland', desc: 'Zeige alle St\u00e4dte in Deutschland mit Einwohnerzahl! (L_ID = \'D\')', hint: 'WHERE L_ID = \'D\' auf Tabelle STADT', sol: 'SELECT ST_NAME, EINWOHNER FROM STADT WHERE L_ID = \'D\' ORDER BY EINWOHNER DESC' },
            { id: 'n0-11', n: '0', title: 'Millionenst\u00e4dte', desc: 'Welche St\u00e4dte haben mehr als 5 Millionen Einwohner?', hint: 'WHERE EINWOHNER > 5000000 auf STADT', sol: 'SELECT ST_NAME, EINWOHNER FROM STADT WHERE EINWOHNER > 5000000 ORDER BY EINWOHNER DESC' },
            { id: 'n0-12', n: '0', title: 'Sandw\u00fcsten', desc: 'Zeige alle W\u00fcsten vom Typ "Sand"! (Tabelle: WUESTE, Spalte: WUESTENART)', hint: 'WHERE WUESTENART = \'Sand\'', sol: 'SELECT W_NAME, FLAECHE, WUESTENART FROM WUESTE WHERE WUESTENART = \'Sand\'' },
            { id: 'n0-13', n: '0', title: 'Gro\u00dfe Inseln', desc: 'Welche Inseln sind gr\u00f6\u00dfer als 100.000 km\u00b2? (Tabelle: INSEL)', hint: 'WHERE FLAECHE > 100000', sol: 'SELECT I_NAME, FLAECHE FROM INSEL WHERE FLAECHE > 100000 ORDER BY FLAECHE DESC' },
            { id: 'n0-14', n: '0', title: 'Tiefe Meere', desc: 'Zeige alle Meere sortiert nach Tiefe (tiefstes zuerst)! (Tabelle: MEER)', hint: 'ORDER BY TIEFE DESC', sol: 'SELECT M_NAME, TIEFE FROM MEER ORDER BY TIEFE DESC' },
            { id: 'n0-15', n: '0', title: 'Hauptstadt mit A', desc: 'Welche L\u00e4nder haben eine Hauptstadt, die mit "A" anf\u00e4ngt?', hint: 'WHERE HAUPTSTADT LIKE \'A%\'', sol: 'SELECT L_NAME, HAUPTSTADT FROM LAND WHERE HAUPTSTADT LIKE \'A%\'' },
            { id: 'n0-16', n: '0', title: 'Berge zwischen 4000 und 5000m', desc: 'Finde alle Berge zwischen 4000 und 5000 Meter H\u00f6he!', hint: 'BETWEEN ... AND ... oder zwei Bedingungen mit AND', sol: 'SELECT B_NAME, HOEHE FROM BERG WHERE HOEHE BETWEEN 4000 AND 5000' },
            { id: 'n0-17', n: '0', title: 'Alpen oder Anden', desc: 'Zeige alle Berge in den Alpen ODER den Anden!', hint: 'WHERE ... IN (...) oder WHERE ... OR ...', sol: 'SELECT B_NAME, GEBIRGE, HOEHE FROM BERG WHERE GEBIRGE IN (\'Alpen\', \'Anden\')' },
            { id: 'n0-18', n: '0', title: 'Seen mit gro\u00dfer Fl\u00e4che', desc: 'Welche Seen haben eine Fl\u00e4che von mehr als 10.000 km\u00b2? (Tabelle: SEE)', hint: 'WHERE FLAECHE > 10000', sol: 'SELECT S_NAME, FLAECHE FROM SEE WHERE FLAECHE > 10000 ORDER BY FLAECHE DESC' },

            // =====================================================
            // Niveau 1: Aggregation (COUNT, MAX, MIN, AVG, SUM)
            // =====================================================
            { id: 'n1-1', n: '1', title: 'Anzahl L\u00e4nder', desc: 'Wie viele L\u00e4nder gibt es in der Datenbank?', hint: 'COUNT(*) auf LAND', sol: 'SELECT COUNT(*) FROM LAND' },
            { id: 'n1-2', n: '1', title: 'Gr\u00f6\u00dftes Land', desc: 'Welches Land hat die gr\u00f6\u00dfte Fl\u00e4che? Zeige Name und Fl\u00e4che!', hint: 'ORDER BY FLAECHE DESC LIMIT 1 oder MAX()', sol: 'SELECT L_NAME, FLAECHE FROM LAND ORDER BY FLAECHE DESC LIMIT 1' },
            { id: 'n1-3', n: '1', title: 'Bev\u00f6lkerungsreichstes Land', desc: 'Wie viele Einwohner hat das bev\u00f6lkerungsreichste Land?', hint: 'MAX(EINWOHNER)', sol: 'SELECT L_NAME, EINWOHNER FROM LAND ORDER BY EINWOHNER DESC LIMIT 1' },
            { id: 'n1-4', n: '1', title: 'L\u00e4ngster Fluss', desc: 'Wie lang ist der l\u00e4ngste Fluss?', hint: 'MAX(LAENGE) auf FLUSS', sol: 'SELECT F_NAME, LAENGE FROM FLUSS ORDER BY LAENGE DESC LIMIT 1' },
            { id: 'n1-5', n: '1', title: 'Anzahl Gebirge', desc: 'Wie viele verschiedene Gebirge gibt es?', hint: 'COUNT(DISTINCT GEBIRGE)', sol: 'SELECT COUNT(DISTINCT GEBIRGE) FROM BERG' },
            { id: 'n1-6', n: '1', title: 'Durchschnittliche Bergh\u00f6he', desc: 'Durchschnittliche H\u00f6he aller Berge?', hint: 'AVG(HOEHE)', sol: 'SELECT AVG(HOEHE) FROM BERG' },
            { id: 'n1-7', n: '1', title: 'Anzahl St\u00e4dte', desc: 'Wie viele St\u00e4dte enth\u00e4lt die Datenbank?', hint: 'COUNT(*) auf STADT', sol: 'SELECT COUNT(*) FROM STADT' },
            { id: 'n1-8', n: '1', title: 'Tiefster See', desc: 'Wie hei\u00dft der tiefste See und wie tief ist er?', hint: 'ORDER BY TIEFE DESC LIMIT 1', sol: 'SELECT S_NAME, TIEFE FROM SEE ORDER BY TIEFE DESC LIMIT 1' },
            { id: 'n1-9', n: '1', title: 'Gr\u00f6\u00dfte Insel', desc: 'Welche Insel hat die gr\u00f6\u00dfte Fl\u00e4che?', hint: 'ORDER BY FLAECHE DESC LIMIT 1 auf INSEL', sol: 'SELECT I_NAME, FLAECHE FROM INSEL ORDER BY FLAECHE DESC LIMIT 1' },
            { id: 'n1-10', n: '1', title: 'Tiefstes Meer', desc: 'Welches Meer ist am tiefsten?', hint: 'ORDER BY TIEFE DESC LIMIT 1 auf MEER', sol: 'SELECT M_NAME, TIEFE FROM MEER ORDER BY TIEFE DESC LIMIT 1' },
            { id: 'n1-11', n: '1', title: 'Anzahl W\u00fcsten', desc: 'Wie viele W\u00fcsten gibt es in der Datenbank?', hint: 'COUNT(*) auf WUESTE', sol: 'SELECT COUNT(*) FROM WUESTE' },

            // =====================================================
            // Niveau 2: GROUP BY & HAVING
            // =====================================================
            { id: 'n2-1', n: '2', title: 'Berge pro Gebirge', desc: 'Wie viele Berge pro Gebirge? (sortiert)', hint: 'GROUP BY GEBIRGE', sol: 'SELECT GEBIRGE, COUNT(*) AS Anzahl FROM BERG GROUP BY GEBIRGE ORDER BY Anzahl DESC' },
            { id: 'n2-2', n: '2', title: 'Gebirge mit >10 Bergen', desc: 'Welche Gebirge haben mehr als 10 Berge?', hint: 'HAVING COUNT(*) > 10', sol: 'SELECT GEBIRGE, COUNT(*) AS Anzahl FROM BERG GROUP BY GEBIRGE HAVING COUNT(*) > 10' },
            { id: 'n2-3', n: '2', title: 'Durchschnitt pro Gebirge', desc: 'Durchschnittliche H\u00f6he pro Gebirge?', hint: 'AVG(HOEHE) mit GROUP BY', sol: 'SELECT GEBIRGE, ROUND(AVG(HOEHE), 0) AS Durchschnitt FROM BERG GROUP BY GEBIRGE ORDER BY Durchschnitt DESC' },
            { id: 'n2-4', n: '2', title: 'Max/Min pro Gebirge', desc: 'H\u00f6chster und niedrigster Berg pro Gebirge?', hint: 'MAX() und MIN() mit GROUP BY', sol: 'SELECT GEBIRGE, MAX(HOEHE) AS Hoechster, MIN(HOEHE) AS Niedrigster FROM BERG GROUP BY GEBIRGE' },
            { id: 'n2-5', n: '2', title: 'W\u00fcstenarten', desc: 'Wie viele W\u00fcsten gibt es pro W\u00fcstenart?', hint: 'GROUP BY WUESTENART auf WUESTE', sol: 'SELECT WUESTENART, COUNT(*) AS Anzahl FROM WUESTE GROUP BY WUESTENART ORDER BY Anzahl DESC' },
            { id: 'n2-6', n: '2', title: 'L\u00e4nder pro Kontinent', desc: 'Wie viele L\u00e4nder gibt es pro Kontinent? (Tabelle: UMFASST)', hint: 'GROUP BY K_NAME auf UMFASST', sol: 'SELECT K_NAME, COUNT(*) AS Anzahl FROM UMFASST GROUP BY K_NAME ORDER BY Anzahl DESC' },
            { id: 'n2-7', n: '2', title: 'Inseln pro Inselgruppe', desc: 'Wie viele Inseln geh\u00f6ren zu jeder Inselgruppe? (Nur Gruppen mit >1 Insel)', hint: 'GROUP BY INSELGRUPPE mit HAVING', sol: 'SELECT INSELGRUPPE, COUNT(*) AS Anzahl FROM INSEL GROUP BY INSELGRUPPE HAVING COUNT(*) > 1 ORDER BY Anzahl DESC' },

            // =====================================================
            // Niveau 3a: Einfache JOINs (2 Tabellen)
            // Phase 1: Erste JOINs (STADT ↔ LAND)
            // Phase 2: LEFT JOIN einführen
            // Phase 3: Neue Tabellenpaare (FLUSS ↔ MEER/SEE)
            // Phase 4: WHERE auf die andere Tabelle
            // Phase 5: JOIN + Aggregation
            // =====================================================

            // -- Phase 1: Erste JOINs --
            { id: 'n3a-1', n: '3a', title: 'St\u00e4dte mit L\u00e4ndername',
              desc: 'Zeige alle St\u00e4dte mit dem Namen ihres Landes! STADT und LAND teilen sich die Spalte <code class="inline">L_ID</code> \u2014 das ist dein erster JOIN.',
              hint: 'SELECT s.ST_NAME, l.L_NAME FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID',
              sol: 'SELECT s.ST_NAME, l.L_NAME FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID' },

            { id: 'n3a-2', n: '3a', title: 'Deutsche St\u00e4dte mit Land',
              desc: 'Zeige alle St\u00e4dte in Deutschland mit ihrem L\u00e4ndernamen! (L_ID = \'D\')',
              hint: 'Tabellen: STADT, LAND — JOIN wie vorher, dann WHERE s.L_ID = \'D\'',
              sol: 'SELECT s.ST_NAME, s.EINWOHNER, l.L_NAME FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID WHERE s.L_ID = \'D\' ORDER BY s.EINWOHNER DESC' },

            { id: 'n3a-3', n: '3a', title: 'Top 10 gr\u00f6\u00dfte St\u00e4dte + Land',
              desc: 'Zeige die 10 einwohnerreichsten St\u00e4dte mit ihrem L\u00e4ndernamen!',
              hint: 'Tabellen: STADT, LAND — JOIN + ORDER BY s.EINWOHNER DESC LIMIT 10',
              sol: 'SELECT s.ST_NAME, s.EINWOHNER, l.L_NAME FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID ORDER BY s.EINWOHNER DESC LIMIT 10' },

            // -- Phase 2: LEFT JOIN einführen --
            { id: 'n3a-14', n: '3a', title: 'LEFT JOIN: L\u00e4nder ohne St\u00e4dte',
              desc: 'Welche L\u00e4nder haben <em>keine einzige</em> Stadt in der Datenbank? Ein normaler JOIN zeigt nur L\u00e4nder <em>mit</em> St\u00e4dten. Ein <code class="inline">LEFT JOIN</code> beh\u00e4lt alle L\u00e4nder \u2014 auch die ohne Partner. Filtere dann auf <code class="inline">WHERE s.ST_NAME IS NULL</code>.',
              hint: 'FROM LAND l LEFT JOIN STADT s ON l.L_ID = s.L_ID WHERE s.ST_NAME IS NULL',
              sol: 'SELECT l.L_NAME FROM LAND l LEFT JOIN STADT s ON l.L_ID = s.L_ID WHERE s.ST_NAME IS NULL ORDER BY l.L_NAME' },

            { id: 'n3a-4', n: '3a', title: 'Millionenst\u00e4dte mit Land',
              desc: 'Welche St\u00e4dte haben mehr als 5 Millionen Einwohner? Zeige Stadt, Einwohner und L\u00e4ndername!',
              hint: 'Tabellen: STADT, LAND — JOIN + WHERE s.EINWOHNER > 5000000',
              sol: 'SELECT s.ST_NAME, s.EINWOHNER, l.L_NAME FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID WHERE s.EINWOHNER > 5000000 ORDER BY s.EINWOHNER DESC' },

            // -- Phase 3: Neue Tabellenpaare --
            { id: 'n3a-11', n: '3a', title: 'Fl\u00fcsse und ihre Meere',
              desc: 'Nicht nur STADT und LAND lassen sich verbinden! Die Tabelle FLUSS hat eine Spalte <code class="inline">MEER</code>, die Tabelle MEER hat <code class="inline">M_NAME</code>. Zeige Flussname, Flussl\u00e4nge und Meeresname!',
              hint: 'FROM FLUSS f JOIN MEER m ON f.MEER = m.M_NAME',
              sol: 'SELECT f.F_NAME, f.LAENGE, m.M_NAME FROM FLUSS f JOIN MEER m ON f.MEER = m.M_NAME ORDER BY f.LAENGE DESC' },

            { id: 'n3a-12', n: '3a', title: 'Fl\u00fcsse in Seen',
              desc: 'Welche Fl\u00fcsse m\u00fcnden in einen See? Zeige Flussname, Seename und Seefl\u00e4che! (FLUSS hat Spalte <code class="inline">SEE</code>, SEE hat <code class="inline">S_NAME</code>)',
              hint: 'FROM FLUSS f JOIN SEE s ON f.SEE = s.S_NAME',
              sol: 'SELECT f.F_NAME, s.S_NAME, s.FLAECHE FROM FLUSS f JOIN SEE s ON f.SEE = s.S_NAME' },

            { id: 'n3a-15', n: '3a', title: 'LEFT JOIN: Meere ohne Zufluss',
              desc: 'Welche Meere haben <em>keinen</em> Fluss-Zufluss in der Datenbank? Gleiches Prinzip wie bei den L\u00e4ndern ohne St\u00e4dte!',
              hint: 'FROM MEER m LEFT JOIN FLUSS f ON m.M_NAME = f.MEER WHERE f.F_NAME IS NULL',
              sol: 'SELECT m.M_NAME FROM MEER m LEFT JOIN FLUSS f ON m.M_NAME = f.MEER WHERE f.F_NAME IS NULL ORDER BY m.M_NAME' },

            // -- Phase 4: WHERE auf die andere Tabelle --
            { id: 'n3a-5', n: '3a', title: 'St\u00e4dte in gro\u00dfen L\u00e4ndern',
              desc: 'Zeige alle St\u00e4dte in L\u00e4ndern mit mehr als 100 Millionen Einwohnern! Beachte: Die Bedingung gilt f\u00fcr die <em>Land</em>-Tabelle, nicht f\u00fcr die Stadt.',
              hint: 'Tabellen: STADT, LAND — JOIN + WHERE l.EINWOHNER > 100000000',
              sol: 'SELECT s.ST_NAME, l.L_NAME, l.EINWOHNER FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID WHERE l.EINWOHNER > 100000000 ORDER BY l.EINWOHNER DESC' },

            { id: 'n3a-13', n: '3a', title: 'Fl\u00fcsse in tiefe Meere',
              desc: 'Zeige alle Fl\u00fcsse, die in ein Meer tiefer als 3000m m\u00fcnden! (Flussname, Meeresname, Tiefe)',
              hint: 'FLUSS JOIN MEER + WHERE m.TIEFE > 3000',
              sol: 'SELECT f.F_NAME, m.M_NAME, m.TIEFE FROM FLUSS f JOIN MEER m ON f.MEER = m.M_NAME WHERE m.TIEFE > 3000 ORDER BY m.TIEFE DESC' },

            { id: 'n3a-6', n: '3a', title: 'St\u00e4dte in Riesenl\u00e4ndern',
              desc: 'Welche St\u00e4dte liegen in L\u00e4ndern mit mehr als 5 Millionen km\u00b2 Fl\u00e4che?',
              hint: 'Tabellen: STADT, LAND — JOIN + WHERE l.FLAECHE > 5000000',
              sol: 'SELECT s.ST_NAME, l.L_NAME, l.FLAECHE FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID WHERE l.FLAECHE > 5000000' },

            // -- Phase 5: JOIN + Aggregation --
            { id: 'n3a-7', n: '3a', title: 'Anzahl St\u00e4dte pro Land',
              desc: 'Wie viele St\u00e4dte hat jedes Land in der Datenbank? Zeige L\u00e4ndername und Anzahl, sortiert! Hier kombinierst du JOIN mit GROUP BY.',
              hint: 'Tabellen: STADT, LAND — JOIN + GROUP BY l.L_NAME + COUNT(*)',
              sol: 'SELECT l.L_NAME, COUNT(*) AS Anzahl FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID GROUP BY l.L_NAME ORDER BY Anzahl DESC' },

            { id: 'n3a-8', n: '3a', title: 'L\u00e4nder mit >5 St\u00e4dten',
              desc: 'Welche L\u00e4nder haben mehr als 5 St\u00e4dte in der Datenbank?',
              hint: 'Tabellen: STADT, LAND — Wie vorher, aber mit HAVING COUNT(*) > 5',
              sol: 'SELECT l.L_NAME, COUNT(*) AS Anzahl FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID GROUP BY l.L_NAME HAVING COUNT(*) > 5 ORDER BY Anzahl DESC' },

            { id: 'n3a-9', n: '3a', title: 'Durchschnittliche Stadtgr\u00f6\u00dfe pro Land',
              desc: 'Wie gro\u00df sind die St\u00e4dte im Durchschnitt pro Land? Zeige gerundet!',
              hint: 'Tabellen: STADT, LAND — JOIN + GROUP BY + ROUND(AVG(s.EINWOHNER), 0)',
              sol: 'SELECT l.L_NAME, ROUND(AVG(s.EINWOHNER), 0) AS Durchschnitt FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID GROUP BY l.L_NAME ORDER BY Durchschnitt DESC' },

            { id: 'n3a-10', n: '3a', title: 'Land mit den meisten St\u00e4dten',
              desc: 'Welches Land hat die meisten St\u00e4dte in der Datenbank?',
              hint: 'Tabellen: STADT, LAND — GROUP BY + ORDER BY + LIMIT 1',
              sol: 'SELECT l.L_NAME, COUNT(*) AS Anzahl FROM STADT s JOIN LAND l ON s.L_ID = l.L_ID GROUP BY l.L_NAME ORDER BY Anzahl DESC LIMIT 1' },

            // =====================================================
            // Niveau 3b: JOINs mit Verbindungstabellen (3 Tabellen)
            // =====================================================
            { id: 'n3-1', n: '3b', title: 'Top 10 Berge + L\u00e4nder',
              desc: 'Die 10 h\u00f6chsten Berge mit ihren L\u00e4ndern? BERG hat keine L_ID \u2014 du brauchst den Umweg \u00fcber GEO_BERG!',
              hint: 'BERG \u2192 GEO_BERG (B_NAME) \u2192 LAND (L_ID)',
              sol: 'SELECT b.B_NAME, b.HOEHE, l.L_NAME FROM BERG b JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME JOIN LAND l ON gb.L_ID = l.L_ID ORDER BY b.HOEHE DESC LIMIT 10' },

            { id: 'n3-2', n: '3b', title: 'L\u00e4nder mit >6000m Bergen',
              desc: 'Welche L\u00e4nder haben Berge \u00fcber 6000m? (Jedes Land nur einmal!)',
              hint: 'Tabellen: BERG, GEO_BERG, LAND — DISTINCT + JOIN mit WHERE',
              sol: 'SELECT DISTINCT l.L_NAME FROM BERG b JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME JOIN LAND l ON gb.L_ID = l.L_ID WHERE b.HOEHE > 6000' },

            { id: 'n3-3', n: '3b', title: 'Berge in Deutschland',
              desc: 'Zeige alle Berge in Deutschland mit H\u00f6he und Gebirge! (L_ID = \'D\')',
              hint: 'BERG \u2192 GEO_BERG mit WHERE gb.L_ID = \'D\'',
              sol: 'SELECT b.B_NAME, b.HOEHE, b.GEBIRGE FROM BERG b JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME WHERE gb.L_ID = \'D\'' },

            { id: 'n3-4', n: '3b', title: 'Fl\u00fcsse in Frankreich',
              desc: 'Welche Fl\u00fcsse flie\u00dfen durch Frankreich? (L_ID = \'F\') Zeige Name und L\u00e4nge!',
              hint: 'FLUSS \u2192 GEO_FLUSS mit WHERE L_ID = \'F\'',
              sol: 'SELECT f.F_NAME, f.LAENGE FROM FLUSS f JOIN GEO_FLUSS gf ON f.F_NAME = gf.F_NAME WHERE gf.L_ID = \'F\' ORDER BY f.LAENGE DESC' },

            { id: 'n3-5', n: '3b', title: 'Seen in Russland',
              desc: 'Welche Seen liegen in Russland? (L_ID = \'RUS\') Zeige Name und Tiefe!',
              hint: 'SEE \u2192 GEO_SEE mit WHERE L_ID = \'RUS\'',
              sol: 'SELECT s.S_NAME, s.TIEFE FROM SEE s JOIN GEO_SEE gs ON s.S_NAME = gs.S_NAME WHERE gs.L_ID = \'RUS\' ORDER BY s.TIEFE DESC' },

            { id: 'n3-6', n: '3b', title: 'Land mit den meisten Bergen',
              desc: 'Welches Land hat die meisten Berge? (Name und Anzahl)',
              hint: 'Tabellen: LAND, GEO_BERG — JOIN + GROUP BY + ORDER BY + LIMIT 1',
              sol: 'SELECT l.L_NAME, COUNT(*) AS Anzahl FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID GROUP BY l.L_NAME ORDER BY Anzahl DESC LIMIT 1' },

            { id: 'n3-7', n: '3b', title: 'St\u00e4dte am Rhein',
              desc: 'Welche St\u00e4dte liegen am Rhein? (Tabelle: LIEGT_AN, Spalte: F_NAME)',
              hint: 'STADT \u2192 LIEGT_AN mit WHERE F_NAME = \'Rhein\'',
              sol: 'SELECT DISTINCT la.ST_NAME FROM LIEGT_AN la WHERE la.F_NAME = \'Rhein\'' },

            { id: 'n3-8', n: '3b', title: 'L\u00e4nder + Berganzahl',
              desc: 'Zeige alle L\u00e4nder mit der Anzahl ihrer Berge (nur L\u00e4nder mit mindestens einem Berg)!',
              hint: 'LAND \u2192 GEO_BERG + GROUP BY + HAVING',
              sol: 'SELECT l.L_NAME, COUNT(*) AS Anzahl FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID GROUP BY l.L_NAME HAVING COUNT(*) > 0 ORDER BY Anzahl DESC' },

            // =====================================================
            // Niveau 4: Kombination (JOIN + GROUP BY + HAVING)
            // =====================================================
            { id: 'n4-1', n: '4', title: 'Anzahl L\u00e4nder >5000m',
              desc: 'Wie viele L\u00e4nder haben mindestens einen Berg \u00fcber 5000m?',
              hint: 'Tabellen: LAND, GEO_BERG, BERG — COUNT(DISTINCT) mit JOIN und WHERE',
              sol: 'SELECT COUNT(DISTINCT l.L_ID) FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME WHERE b.HOEHE > 5000' },

            { id: 'n4-2', n: '4', title: 'H\u00f6chster Durchschnitt',
              desc: 'Welches Land hat die h\u00f6chste durchschnittliche Bergh\u00f6he?',
              hint: 'Tabellen: LAND, GEO_BERG, BERG — AVG mit GROUP BY, ORDER BY und LIMIT 1',
              sol: 'SELECT l.L_NAME, ROUND(AVG(b.HOEHE), 0) AS Durchschnitt FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME ORDER BY Durchschnitt DESC LIMIT 1' },

            { id: 'n4-3', n: '4', title: 'L\u00e4nderstatistik',
              desc: 'F\u00fcr jedes Land: Anzahl und Durchschnittsh\u00f6he der Berge?',
              hint: 'Tabellen: LAND, GEO_BERG, BERG — COUNT und AVG kombinieren mit JOIN und GROUP BY',
              sol: 'SELECT l.L_NAME, COUNT(b.B_NAME) AS Anzahl, ROUND(AVG(b.HOEHE), 0) AS Durchschnitt FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME ORDER BY Durchschnitt DESC' },

            { id: 'n4-4', n: '4', title: 'Bergstarke L\u00e4nder',
              desc: 'Welche L\u00e4nder haben mehr als 5 Berge UND eine Durchschnittsh\u00f6he \u00fcber 3000m?',
              hint: 'Tabellen: LAND, GEO_BERG, BERG — HAVING mit zwei Bedingungen (COUNT und AVG)',
              sol: 'SELECT l.L_NAME, COUNT(*) AS Anzahl, ROUND(AVG(b.HOEHE), 0) AS Durchschnitt FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME HAVING COUNT(*) > 5 AND AVG(b.HOEHE) > 3000' },

            { id: 'n4-5', n: '4', title: 'Fl\u00fcsse pro Land',
              desc: 'Wie viele Fl\u00fcsse flie\u00dfen durch jedes Land? Top 10!',
              hint: 'LAND \u2192 GEO_FLUSS mit GROUP BY und LIMIT 10',
              sol: 'SELECT l.L_NAME, COUNT(*) AS Anzahl FROM LAND l JOIN GEO_FLUSS gf ON l.L_ID = gf.L_ID GROUP BY l.L_NAME ORDER BY Anzahl DESC LIMIT 10' },

            { id: 'n4-6', n: '4', title: 'Europ\u00e4ische Berge',
              desc: 'Zeige alle Berge in europ\u00e4ischen L\u00e4ndern mit L\u00e4ndername! (K_NAME = \'Europa\' in UMFASST)',
              hint: '4 Tabellen: BERG \u2192 GEO_BERG \u2192 LAND + UMFASST',
              sol: 'SELECT b.B_NAME, b.HOEHE, l.L_NAME FROM BERG b JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME JOIN LAND l ON gb.L_ID = l.L_ID JOIN UMFASST u ON l.L_ID = u.L_ID WHERE u.K_NAME = \'Europa\' ORDER BY b.HOEHE DESC' },

            { id: 'n4-7', n: '4', title: 'Seen pro Land',
              desc: 'Welche L\u00e4nder haben die meisten Seen? Top 5! (GEO_SEE)',
              hint: 'LAND \u2192 GEO_SEE mit GROUP BY und LIMIT',
              sol: 'SELECT l.L_NAME, COUNT(*) AS Anzahl FROM LAND l JOIN GEO_SEE gs ON l.L_ID = gs.L_ID GROUP BY l.L_NAME ORDER BY Anzahl DESC LIMIT 5' }
        ];
        
        const tabScrollPositions = {};
        let currentTab = 'editor';

        function switchTab(name) {
            tabScrollPositions[currentTab] = window.scrollY;
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
            currentTab = name;
            requestAnimationFrame(() => { window.scrollTo(0, tabScrollPositions[name] || 0); });
        }

        function loadLocalFile(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            const statusEl = document.getElementById('db-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = `<div class="message warning">Lade lokale Datei: ${file.name}...</div>`;
            reader.onload = async function() {
                try { await initSqlJsWithBuffer(reader.result, `Lokal: ${file.name}`); }
                catch(e) { statusEl.innerHTML = `<div class="message error">Fehler: ${e.message}</div>`; }
            };
            reader.readAsArrayBuffer(file);
        }

        async function initSqlJsWithBuffer(buffer, sourceName) {
            const statusEl = document.getElementById('db-status');
            if (buffer.byteLength < 1000) {
                statusEl.innerHTML = `<div class="message error"><strong>Datei zu klein:</strong> '${sourceName}' ist nur ${buffer.byteLength} Bytes.</div>`;
                return;
            }
            try {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
                db = new SQL.Database(new Uint8Array(buffer));
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='LAND'");
                if (tables.length === 0) {
                    statusEl.innerHTML = `<div class="message error">Datenbank '${sourceName}' geladen, aber Tabelle 'LAND' fehlt.</div>`;
                } else {
                    const rowCount = db.exec("SELECT count(*) FROM LAND")[0].values[0][0];
                    if (rowCount === 0) {
                        statusEl.innerHTML = `<div class="message error">Tabelle 'LAND' ist leer (0 Zeilen).</div>`;
                    } else {
                        statusEl.innerHTML = `<div class="message success">'${sourceName}' geladen. (${rowCount} Länder)</div>`;
                        setTimeout(() => statusEl.style.display = 'none', 3000);
                        runMain();
                    }
                }
                renderTasks();
                updateStats();
            } catch (err) {
                statusEl.innerHTML = `<div class="message error">SQL Fehler: ${err.message}</div>`;
            }
        }
        
        async function initDatabase() {
            const statusEl = document.getElementById('db-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<div class="message warning">Suche Datenbank...</div>';
            const filesToCheck = ['https://lkirchne.github.io/gynesa/informatik/q1/db/terra/terra2023.db','/informatik/q1/db/terra/terra2023.db'];
            let buffer = null, loadedName = '';
            for (let file of filesToCheck) {
                try {
                    const url = file.startsWith('http') ? file : file + '?t=' + Date.now();
                    const res = await fetch(url);
                    if (res.ok) { buffer = await res.arrayBuffer(); loadedName = file; break; }
                } catch(e) {}
            }
            if (!buffer) {
                statusEl.innerHTML = `<div class="message warning"><strong>Keine Datenbank gefunden.</strong> Bitte lade deine Datei oben manuell.</div>`;
                return;
            }
            const decoder = new TextDecoder("utf-8");
            const firstBytes = decoder.decode(new Uint8Array(buffer.slice(0, 50)));
            if (firstBytes.includes("git-lfs")) {
                statusEl.innerHTML = `<div class="message error"><strong>Git LFS Fehler!</strong> Die Datei '${loadedName}' ist nur ein Text-Link.</div>`;
                return;
            }
            await initSqlJsWithBuffer(buffer, loadedName);
        }

        // =====================================================
        // Result rendering helper
        // =====================================================
        function renderResultHtml(res, maxVisible) {
            if (!res || res.length === 0) return '<div style="padding:0.4rem;color:#888;font-style:italic;font-size:0.85rem">Keine Ergebnisse.</div>';
            const r = res[0];
            const total = r.values.length;
            maxVisible = maxVisible || 10;
            let html = `<div class="result-info">${total} Zeile${total !== 1 ? 'n' : ''}</div>`;
            html += '<div class="table-wrapper"><table><thead><tr>';
            html += r.columns.map(c => '<th>' + c + '</th>').join('') + '</tr></thead><tbody>';
            r.values.forEach((row, i) => {
                const hidden = i >= maxVisible ? ' style="display:none" class="extra-row extra-' + Date.now() + '"' : '';
                html += '<tr' + hidden + '>' + row.map(c => '<td>' + (c === null ? '<span style="color:#aaa">NULL</span>' : c) + '</td>').join('') + '</tr>';
            });
            html += '</tbody></table></div>';
            if (total > maxVisible) {
                const uid = 'g' + Math.random().toString(36).slice(2, 8);
                html = html.replace(new RegExp('extra-' + '\\d+', 'g'), uid);
                html += `<button style="margin-top:0.4rem;font-size:0.8rem;" onclick="this.parentElement.querySelectorAll('.${uid}').forEach(r=>r.style.display='');this.style.display='none';">Alle ${total} Zeilen anzeigen</button>`;
            }
            return html;
        }

        // =====================================================
        // Result comparison (flexible)
        // =====================================================
        function resultsMatch(r1, r2, solSql) {
            if (!r1 || !r2) return false;
            // Both empty
            if (r1.length === 0 && r2.length === 0) return true;
            if (r1.length === 0 || r2.length === 0) return false;
            const a = r1[0], b = r2[0];
            // Same number of columns and rows
            if (a.columns.length !== b.columns.length) return false;
            if (a.values.length !== b.values.length) return false;

            // Normalize column names (strip alias prefixes, uppercase)
            const normCol = c => c.toUpperCase().replace(/.*\./, '');
            const colsA = a.columns.map(normCol);
            const colsB = b.columns.map(normCol);

            // Find column mapping: for each col in A, find matching col in B
            // This allows flexible column order (SELECT Name, Stadt vs SELECT Stadt, Name)
            const mapping = [];
            const usedB = new Set();
            for (let i = 0; i < colsA.length; i++) {
                let found = -1;
                for (let j = 0; j < colsB.length; j++) {
                    if (!usedB.has(j) && colsA[i] === colsB[j]) {
                        found = j;
                        usedB.add(j);
                        break;
                    }
                }
                if (found === -1) return false; // column not found
                mapping.push(found);
            }

            // Reorder B's values to match A's column order
            const reorderRow = row => mapping.map(j => row[j]);
            const bVals = b.values.map(reorderRow);

            // Check if solution uses ORDER BY → require same row order
            const hasOrderBy = solSql && /ORDER\s+BY/i.test(solSql);

            if (hasOrderBy) {
                // Strict row order: compare directly
                return JSON.stringify(a.values) === JSON.stringify(bVals);
            } else {
                // Any row order OK: sort then compare
                const sortRows = v => v.map(r => JSON.stringify(r)).sort();
                return JSON.stringify(sortRows(a.values)) === JSON.stringify(sortRows(bVals));
            }
        }
        
        // =====================================================
        // Run query (for playground)
        // =====================================================
        function runQuery(q) {
            if (!db || !q.trim()) return null;
            return db.exec(q);
        }

        function runMain() {
            const el = document.getElementById('main-result');
            el.innerHTML = '';
            if (!db) return;
            const q = document.getElementById('main-editor').value;
            try {
                document.getElementById('main-result-header').style.display = 'block';
                el.innerHTML = renderResultHtml(db.exec(q));
            } catch(e) {
                el.innerHTML = '<div class="message error">SQL Fehler: ' + e.message + '</div>';
            }
        }

        function clearMain() { 
            document.getElementById('main-editor').value = ''; 
            document.getElementById('main-result').innerHTML = ''; 
            document.getElementById('main-result-header').style.display = 'none';
        }
        
        function renderTasks() {
            const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
            const grouped = {};
            tasks.forEach(t => { if (!grouped[t.n]) grouped[t.n] = []; grouped[t.n].push(t); });
            
            let html = '';
            niveauOrder.forEach(n => {
                if (!grouped[n]) return;
                const label = niveauLabels[n] || '';
                const nTasks = grouped[n];
                const nSolved = nTasks.filter(t => saved[t.id] && isSolved(t, saved[t.id])).length;
                const pct = Math.round(nSolved / nTasks.length * 100);
                const cssClass = 'niveau-' + n.replace(/\s/g,'');

                html += `<div class="section niveau-section ${cssClass}" id="section-${n}">`;
                html += `<h2>Niveau ${n}${label ? ' \u2014 ' + label : ''}</h2>`;
                html += `<div class="niveau-progress">
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                    <div class="progress-text">${nSolved}/${nTasks.length}</div>
                </div>`;

                nTasks.forEach(t => {
                    const q = saved[t.id] || '';
                    const solved = q && isSolved(t, q);
                    html += `<div class="task ${cssClass} ${solved ? 'solved' : ''}" data-id="${t.id}">
                        <div class="task-header" ${solved ? 'onclick="toggleSolved(this.parentElement)"' : ''}>
                            <div class="task-title">${t.title}<span class="expand-hint">(klicken zum Aufklappen)</span></div>
                            <span class="badge ${solved ? 'solved' : ''}">N${t.n}</span>
                        </div>
                        <div class="task-body">
                            <div class="task-desc">${t.desc}</div>
                            <textarea id="t-${t.id}" placeholder="SELECT ...">${q}</textarea>
                            <div class="button-group">
                                <button class="btn-primary" onclick="event.stopPropagation(); checkTask('${t.id}')">Überprüfen</button>
                                <button onclick="event.stopPropagation(); runTask('${t.id}')">Nur Ausführen</button>
                                <button onclick="event.stopPropagation(); toggleHint('${t.id}')">Hinweis</button>
                            </div>
                            <div id="hint-${t.id}" class="hint"><strong>Tipp:</strong> ${t.hint}</div>
                            <div id="res-${t.id}"></div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            });
            document.getElementById('tasks').innerHTML = html;
            document.getElementById('total').textContent = tasks.length;
        }

        function toggleSolved(el) {
            el.classList.toggle('expanded');
        }

        function isSolved(task, q) {
            if (!db || !q || !q.trim()) return false;
            try {
                const ur = db.exec(q);
                const sr = db.exec(task.sol);
                return resultsMatch(ur, sr, task.sol);
            } catch(e) { return false; }
        }
        
        function checkTask(id) {
            const task = tasks.find(t => t.id === id);
            const q = document.getElementById('t-' + id).value;
            const el = document.getElementById('res-' + id);
            
            if (!q.trim()) { 
                el.innerHTML = '<div class="message error">Bitte gib eine Query ein.</div>'; 
                return; 
            }

            let studentResult, solResult;
            
            // Run student query
            try {
                studentResult = db.exec(q);
            } catch(e) {
                el.innerHTML = `<div class="message error">SQL Fehler: ${e.message}</div>`;
                return;
            }

            // Run solution query
            try {
                solResult = db.exec(task.sol);
            } catch(e) {
                solResult = [];
            }

            // Compare
            const match = resultsMatch(studentResult, solResult, task.sol);

            let html = '';

            if (match) {
                html += '<div class="message success" style="margin-bottom:0.5rem">Korrekt!</div>';
                const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
                saved[id] = q;
                localStorage.setItem('terra-sql', JSON.stringify(saved));
                const taskEl = document.querySelector(`.task[data-id="${id}"]`);
                taskEl.classList.add('solved', 'expanded');
                taskEl.querySelector('.task-header').setAttribute('onclick', 'toggleSolved(this.parentElement)');
                const badge = taskEl.querySelector('.badge');
                badge.classList.add('solved');
                badge.innerHTML = `N${task.n}`;
                updateStats();
                updateNiveauProgress(task.n);
            } else {
                html += '<div class="message warning" style="margin-bottom:0.5rem">Vergleiche dein Ergebnis mit dem erwarteten Ergebnis.</div>';
            }

            // Student result
            html += '<div class="result-label">Dein Ergebnis:</div>';
            html += renderResultHtml(studentResult);

            // Expected result
            html += '<div class="expected-block">';
            html += '<div class="result-label">Erwartetes Ergebnis:</div>';
            html += renderResultHtml(solResult);
            html += '</div>';

            el.innerHTML = html;
        }
        
        function runTask(id) { 
            const q = document.getElementById('t-' + id).value;
            const el = document.getElementById('res-' + id);
            if (!q.trim()) { el.innerHTML = ''; return; }
            try {
                el.innerHTML = renderResultHtml(db.exec(q));
            } catch(e) {
                el.innerHTML = '<div class="message error">SQL Fehler: ' + e.message + '</div>';
            }
        }
        
        function toggleHint(id) { document.getElementById('hint-' + id).classList.toggle('visible'); }
        
        function updateStats() {
            const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
            let solved = 0;
            tasks.forEach(t => {
                if (saved[t.id] && isSolved(t, saved[t.id])) solved++;
            });
            document.getElementById('solved').textContent = solved;
            document.getElementById('progress').textContent = Math.round(solved / tasks.length * 100) + '%';
        }

        function updateNiveauProgress(n) {
            const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
            const nTasks = tasks.filter(t => t.n === n);
            const nSolved = nTasks.filter(t => saved[t.id] && isSolved(t, saved[t.id])).length;
            const pct = Math.round(nSolved / nTasks.length * 100);
            const section = document.getElementById('section-' + n);
            if (!section) return;
            const fill = section.querySelector('.progress-fill');
            const text = section.querySelector('.progress-text');
            if (fill) fill.style.width = pct + '%';
            if (text) text.textContent = nSolved + '/' + nTasks.length;
        }
        
        function exportSolutions() {
            const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
            let md = '# SQL Übungen\n\n**Datum:** ' + new Date().toLocaleDateString('de-DE') + '\n';
            md += '**Gelöst:** ' + document.getElementById('solved').textContent + '/' + tasks.length + '\n\n---\n\n';
            const grouped = {};
            tasks.forEach(t => { if (!grouped[t.n]) grouped[t.n] = []; grouped[t.n].push(t); });
            niveauOrder.forEach(n => {
                if (!grouped[n]) return;
                md += `## Niveau ${n} — ${niveauLabels[n]}\n\n`;
                grouped[n].forEach(t => {
                    const q = saved[t.id] || '';
                    const ok = q && isSolved(t, q);
                    md += `### ${t.title} ${ok ? '[gelöst]' : ''}\n\n${t.desc}\n\n`;
                    if (q) {
                        md += '```sql\n' + q + '\n```\n\n';
                        try {
                            const r = db.exec(q);
                            if (r.length && r[0].values.length <= 10) {
                                md += '| ' + r[0].columns.join(' | ') + ' |\n';
                                md += '|' + r[0].columns.map(() => '---').join('|') + '|\n';
                                r[0].values.forEach(row => md += '| ' + row.map(v => v !== null ? v : 'NULL').join(' | ') + ' |\n');
                                md += '\n';
                            }
                        } catch(e) {}
                    }
                    md += '---\n\n';
                });
            });
            const blob = new Blob([md], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'SQL-Loesungen-' + new Date().toISOString().split('T')[0] + '.md';
            a.click();
        }
        
        function resetApp() {
            if(confirm("Bist du sicher? Dies löscht deinen gespeicherten Fortschritt.\nDie Seite wird danach neu geladen.")) {
                localStorage.clear();
                if('caches' in window) caches.keys().then(names => { for (let n of names) caches.delete(n); });
                const url = new URL(window.location.href);
                url.searchParams.set('reloadTime', Date.now());
                window.location.href = url.toString();
            }
        }

        initDatabase();
    </script>
</body>
</html>
