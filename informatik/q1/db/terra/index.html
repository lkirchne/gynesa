<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Übungen - Terra Datenbank</title>
    <!-- Fonts für das Design -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        :root {
            /* Das gewünschte Pastell-Schema */
            --bg-body: #fdfcfc;
            --bg-surface: #ffffff;
            --text-main: #334155;
            --text-muted: #64748b;
            
            --primary: #7dd3fc; /* Pastel Blue */
            --primary-dark: #0ea5e9;
            --primary-bg: #f0f9ff;
            --accent: #818cf8;
            
            --border-color: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            
            --success-bg: #dcfce7;
            --success-text: #166534;
            --success-border: #86efac;
            
            --error-bg: #fee2e2;
            --error-text: #991b1b;
            --error-border: #fca5a5;
            
            --warning-bg: #fff7ed;
            --warning-text: #9a3412;
            --warning-border: #fdba74;
            
            --code-font: 'Source Code Pro', monospace;
            --body-font: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--body-font);
            background: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Sticky Header Wrapper */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-surface);
            box-shadow: var(--shadow-sm);
            border-bottom: 1px solid var(--border-color);
        }

        /* Top Bar inside Sticky Header */
        .header-top {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .header-content h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            letter-spacing: -0.025em;
            margin: 0;
        }
        
        .subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 0;
        }

        /* Navigation Bar inside Sticky Header */
        .header-nav {
            background: var(--bg-surface);
            padding: 0.5rem 0;
        }

        .nav-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        nav {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            /* Reset old margins */
            margin: 0;
            padding: 0;
        }
        
        nav button {
            background: transparent;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        nav button:hover {
            background: #f1f5f9;
            color: var(--text-main);
        }
        
        nav button.active {
            background: var(--primary-bg);
            color: var(--primary-dark);
            font-weight: 600;
        }

        /* File Upload Button Styled */
        .file-upload-btn {
            background: var(--bg-surface);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .file-upload-btn:hover {
            background: var(--primary-bg);
            color: var(--primary-dark);
            border-color: var(--primary);
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        /* Status Bar */
        #db-status {
            margin-bottom: 1.5rem;
            display: none;
        }
        
        /* Stats */
        .stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            background: var(--bg-surface);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .stats span {
            font-weight: 600;
            color: var(--text-main);
        }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Sections & Cards */
        .section {
            background: var(--bg-surface);
            padding: 2rem;
            margin-bottom: 1.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        
        .section h2 {
            font-size: 1.25rem;
            margin-bottom: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .section h3 {
            font-size: 1rem;
            margin: 1.5rem 0 0.75rem 0;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Editors & Inputs */
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            font-family: var(--code-font);
            font-size: 0.9rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: #f8fafc;
            resize: vertical;
            color: #334155;
            transition: border-color 0.2s, background 0.2s;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        button {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            background: #fff;
            border: 1px solid #cbd5e1;
            cursor: pointer;
            font-family: inherit;
            border-radius: 6px;
            font-weight: 500;
            color: #475569;
            transition: all 0.2s;
        }
        
        button:hover { background: #f8fafc; border-color: #94a3b8; }
        button:active { transform: translateY(1px); }
        
        .btn-primary {
            background: #3b82f6; /* Modern Blue */
            color: #fff;
            border: none;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover { background: #2563eb; border-color: transparent; }
        
        /* Tables - BEAUTIFIED */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 1rem;
            background: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 600px; /* Ensure table doesn't squish too much */
        }
        
        th {
            text-align: left;
            padding: 0.85rem 1rem;
            background: #f1f5f9;
            color: #475569;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
            vertical-align: top;
        }
        
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background-color: #fafbfc; }
        tr:hover td { background-color: #f0f9ff; }
        
        /* Messages & Feedback */
        .message {
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        
        .success { 
            background: var(--success-bg); 
            color: var(--success-text); 
            border: 1px solid var(--success-border);
        }
        
        .error { 
            background: var(--error-bg); 
            color: var(--error-text); 
            border: 1px solid var(--error-border);
        }
        
        .warning {
            background: var(--warning-bg);
            color: var(--warning-text);
            border: 1px solid var(--warning-border);
        }
        
        /* Tasks */
        .task {
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: #fff;
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .task:hover {
            box-shadow: var(--shadow-sm);
        }
        
        .task.solved {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .task-title {
            font-weight: 600;
            font-size: 1.05rem;
            color: #1e293b;
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            background: #f1f5f9;
            border-radius: 999px;
            font-weight: 600;
            color: #64748b;
        }
        
        .badge.solved { 
            background: #dcfce7; 
            color: #15803d;
        }
        
        .task-desc {
            color: #475569;
            font-size: 0.95rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        /* Hints & Help */
        .hint {
            background: #fffbeb;
            border: 1px solid #fef3c7;
            color: #92400e;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
            font-size: 0.9rem;
            border-radius: 8px;
        }
        
        .hint.visible { display: block; animation: fadeIn 0.3s; }
        
        .help-block {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
        }
        
        .help-block h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        
        .help-block code {
            display: block;
            font-family: var(--code-font);
            font-size: 0.85rem;
            background: #fff;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            white-space: pre;
            overflow-x: auto;
            color: #0f172a;
        }
        
        code.inline {
            font-family: var(--code-font);
            background: #f1f5f9;
            padding: 0.1rem 0.3rem;
            font-size: 0.9em;
            border-radius: 4px;
            color: #0f172a;
        }
        
        .result-info {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0.5rem 0;
            text-align: right;
            font-family: var(--code-font);
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <!-- Sticky Header Wrapper -->
    <div class="sticky-header">
        <div class="header-top">
            <div class="header-content">
                <h1>SQL Übungen - Terra Datenbank</h1>
                <p class="subtitle">Aggregationsfunktionen & JOINs</p>
            </div>
            <div>
                <!-- Hidden File Input -->
                <input type="file" id="local-file-input" accept=".db,.sqlite,.sqlite3" style="display: none;" onchange="loadLocalFile(this)">
                <button class="file-upload-btn" onclick="document.getElementById('local-file-input').click()">
                    Lokale Datei öffnen
                </button>
            </div>
        </div>
        
        <div class="header-nav">
            <div class="nav-container">
                <nav>
                    <button class="active" onclick="switchTab('editor')">Freier Editor</button>
                    <button onclick="switchTab('tasks')">Aufgaben</button>
                    <button onclick="switchTab('database')">Datenbank Struktur</button>
                    <button onclick="switchTab('help')">Cheat Sheet</button>
                </nav>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Notification Area for DB Status -->
        <div id="db-status"></div>
        
        <div id="tab-editor" class="tab-content active">
            <div class="section">
                <h2>SQL Playground</h2>
                <p style="margin-bottom: 1rem; color: var(--text-muted);">Teste hier deine eigenen Abfragen gegen die Terra-Datenbank.</p>
                <textarea id="main-editor" placeholder="SELECT * FROM BERG ORDER BY HOEHE DESC LIMIT 10;">SELECT * FROM LAND LIMIT 10;</textarea>
                <div class="button-group">
                    <button class="btn-primary" onclick="runMain()">Abfrage Ausführen</button>
                    <button onclick="clearMain()">Leeren</button>
                </div>
                <h3 id="main-result-header" style="display:none; margin-top: 1.5rem; font-size: 1rem; color: var(--text-muted);">Ergebnis:</h3>
                <div id="main-result"></div>
            </div>
        </div>
        
        <div id="tab-tasks" class="tab-content">
            <div class="stats">
                <div>Gelöst: <span id="solved">0</span>/<span id="total">0</span></div>
                <div>Fortschritt: <span id="progress">0%</span></div>
                <div>Niveau: <span id="niveau">1</span></div>
            </div>
            <div id="tasks"></div>
            <div class="section">
                <h2>Lösungen Speichern</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">Exportiere deine Lösungen als Markdown-Datei für deine Unterlagen.</p>
                <button class="btn-primary" onclick="exportSolutions()">Lösungen herunterladen</button>
            </div>
        </div>
        
        <div id="tab-database" class="tab-content">
            <div class="section">
                <h2>Datenbank-Übersicht</h2>
                
                <h3>Haupttabellen</h3>
                
                <div class="help-block">
                    <h4>BERG</h4>
                    <code>B_NAME       varchar(20)   - Bergname
GEBIRGE      varchar(25)   - Gebirgsname
HOEHE        double        - Höhe in Metern
JAHR         int           - Jahr der Erstbesteigung
LAENGE       double        - Längengrad
BREITE       double        - Breitengrad</code>
                </div>
                
                <div class="help-block">
                    <h4>LAND</h4>
                    <code>L_ID         varchar(4)    - Länder-ID
L_NAME       varchar(50)   - Landesname
EINWOHNER    double        - Einwohnerzahl
FLAECHE      double        - Fläche in km²
HAUPTSTADT   varchar(25)   - Hauptstadt
LT_ID        varchar(4)    - Landteil-ID</code>
                </div>
                
                <div class="help-block">
                    <h4>FLUSS</h4>
                    <code>F_NAME       varchar(20)   - Flussname
FLUSS        varchar(20)   - Quellfluss
SEE          varchar(25)   - Mündet in See
MEER         varchar(25)   - Mündet in Meer
LAENGE       int           - Länge in km</code>
                </div>
                
                <div class="help-block">
                    <h4>STADT</h4>
                    <code>ST_NAME      varchar(25)   - Stadtname
L_ID         varchar(4)    - Länder-ID
EINWOHNER    int           - Einwohnerzahl
BREITE       double        - Breitengrad
LAENGE       double        - Längengrad</code>
                </div>
                
                <h3>Verbindungstabellen (für JOINs)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div class="help-block">
                        <h4>GEO_BERG</h4>
                        <code>id           int
L_ID         varchar(4)
B_NAME       varchar(20)

Verbindet: LAND ↔ BERG</code>
                    </div>
                    
                    <div class="help-block">
                        <h4>GEO_FLUSS</h4>
                        <code>L_ID         varchar(4)
F_NAME       varchar(20)

Verbindet: LAND ↔ FLUSS</code>
                    </div>
                    
                    <div class="help-block">
                        <h4>UMFASST</h4>
                        <code>K_NAME       varchar(10)
L_ID         varchar(4)

Verbindet: KONTINENT ↔ LAND</code>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tab-help" class="tab-content">
            <div class="section">
                <h2>SQL Referenz</h2>
                
                <h3>Aggregation</h3>
                <div class="help-block">
                    <h4>COUNT, MAX, MIN, AVG</h4>
                    <code>SELECT COUNT(*) FROM LAND;
SELECT MAX(HOEHE) FROM BERG;
SELECT AVG(FLAECHE) FROM LAND;</code>
                </div>
                
                <h3>Gruppierung</h3>
                <div class="help-block">
                    <h4>GROUP BY & HAVING</h4>
                    <code>SELECT GEBIRGE, COUNT(*)
FROM BERG
GROUP BY GEBIRGE
HAVING COUNT(*) > 5;</code>
                </div>
                
                <h3>Verknüpfung (JOINs)</h3>
                <div class="help-block">
                    <h4>INNER JOIN</h4>
                    <code>SELECT b.B_NAME, l.L_NAME
FROM BERG b
JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME
JOIN LAND l ON gb.L_ID = l.L_ID;</code>
                </div>
            </div>
        </div>

        <div style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-muted);">
            <button onclick="resetApp()" style="background: #fff; color: #64748b; border: 1px solid #cbd5e1; font-size: 0.8rem; padding: 0.5rem 1rem;">
                Cache leeren & App zurücksetzen
            </button>
        </div>
    </div>
    
    <script>
        let db;
        const tasks = [
            { id: 'n1-1', n: 1, title: 'Anzahl Länder', desc: 'Wie viele Länder gibt es in der Datenbank?', hint: 'COUNT(*) auf LAND', sols: ['SELECT COUNT(*) FROM LAND', 'SELECT COUNT(*) AS anzahl FROM LAND', 'SELECT COUNT(L_ID) FROM LAND'] },
            { id: 'n1-2', n: 1, title: 'Größtes Land', desc: 'Wie groß ist das größte Land (nach Fläche)?', hint: 'ORDER BY FLAECHE DESC LIMIT 1 oder MAX()', sols: ['SELECT L_NAME, FLAECHE FROM LAND ORDER BY FLAECHE DESC LIMIT 1', 'SELECT L_NAME, MAX(FLAECHE) FROM LAND', 'SELECT L_NAME, FLAECHE FROM LAND WHERE FLAECHE = (SELECT MAX(FLAECHE) FROM LAND)'] },
            { id: 'n1-3', n: 1, title: 'Bevölkerungsreichstes Land', desc: 'Wie viele Einwohner hat das bevölkerungsreichste Land?', hint: 'MAX(EINWOHNER)', sols: ['SELECT MAX(EINWOHNER) FROM LAND', 'SELECT L_NAME, EINWOHNER FROM LAND ORDER BY EINWOHNER DESC LIMIT 1', 'SELECT EINWOHNER FROM LAND WHERE EINWOHNER = (SELECT MAX(EINWOHNER) FROM LAND)'] },
            { id: 'n1-4', n: 1, title: 'Längster Fluss', desc: 'Wie lang ist der längste Fluss?', hint: 'MAX(LAENGE) auf FLUSS', sols: ['SELECT MAX(LAENGE) FROM FLUSS', 'SELECT F_NAME, LAENGE FROM FLUSS ORDER BY LAENGE DESC LIMIT 1', 'SELECT LAENGE FROM FLUSS WHERE LAENGE = (SELECT MAX(LAENGE) FROM FLUSS)'] },
            { id: 'n1-5', n: 1, title: 'Anzahl Gebirge', desc: 'Wie viele verschiedene Gebirge gibt es?', hint: 'COUNT(DISTINCT GEBIRGE)', sols: ['SELECT COUNT(DISTINCT GEBIRGE) FROM BERG', 'SELECT COUNT(DISTINCT GEBIRGE) AS anzahl FROM BERG'] },
            { id: 'n1-6', n: 1, title: 'Durchschnittliche Berghöhe', desc: 'Durchschnittliche Höhe aller Berge?', hint: 'AVG(HOEHE)', sols: ['SELECT AVG(HOEHE) FROM BERG', 'SELECT AVG(HOEHE) AS durchschnitt FROM BERG', 'SELECT ROUND(AVG(HOEHE), 0) FROM BERG'] },
            { id: 'n2-1', n: 2, title: 'Berge pro Gebirge', desc: 'Wie viele Berge pro Gebirge? (sortiert)', hint: 'GROUP BY GEBIRGE', sols: ['SELECT GEBIRGE, COUNT(*) FROM BERG GROUP BY GEBIRGE ORDER BY COUNT(*) DESC', 'SELECT GEBIRGE, COUNT(*) AS anzahl FROM BERG GROUP BY GEBIRGE ORDER BY anzahl DESC'] },
            { id: 'n2-2', n: 2, title: 'Gebirge mit >10 Bergen', desc: 'Welche Gebirge haben mehr als 10 Berge?', hint: 'HAVING COUNT(*) > 10', sols: ['SELECT GEBIRGE, COUNT(*) FROM BERG GROUP BY GEBIRGE HAVING COUNT(*) > 10', 'SELECT GEBIRGE, COUNT(*) AS anzahl FROM BERG GROUP BY GEBIRGE HAVING COUNT(*) > 10'] },
            { id: 'n2-3', n: 2, title: 'Durchschnitt pro Gebirge', desc: 'Durchschnittliche Höhe pro Gebirge?', hint: 'AVG(HOEHE) mit GROUP BY', sols: ['SELECT GEBIRGE, AVG(HOEHE) FROM BERG GROUP BY GEBIRGE', 'SELECT GEBIRGE, ROUND(AVG(HOEHE), 0) FROM BERG GROUP BY GEBIRGE', 'SELECT GEBIRGE, AVG(HOEHE) AS durchschnitt FROM BERG GROUP BY GEBIRGE ORDER BY durchschnitt DESC'] },
            { id: 'n2-4', n: 2, title: 'Max/Min pro Gebirge', desc: 'Höchster und niedrigster Berg pro Gebirge?', hint: 'MAX() und MIN() mit GROUP BY', sols: ['SELECT GEBIRGE, MAX(HOEHE), MIN(HOEHE) FROM BERG GROUP BY GEBIRGE', 'SELECT GEBIRGE, MAX(HOEHE) AS hoechster, MIN(HOEHE) AS niedrigster FROM BERG GROUP BY GEBIRGE'] },
            { id: 'n3-1', n: 3, title: 'Top 10 Berge + Länder', desc: 'Die 10 höchsten Berge mit ihren Ländern?', hint: 'JOIN über 3 Tabellen', sols: ['SELECT b.B_NAME, b.HOEHE, l.L_NAME FROM BERG b JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME JOIN LAND l ON gb.L_ID = l.L_ID ORDER BY b.HOEHE DESC LIMIT 10', 'SELECT b.B_NAME, b.HOEHE, l.L_NAME FROM BERG b INNER JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME INNER JOIN LAND l ON gb.L_ID = l.L_ID ORDER BY b.HOEHE DESC LIMIT 10'] },
            { id: 'n3-2', n: 3, title: 'Länder >6000m', desc: 'Welche Länder haben Berge über 6000m?', hint: 'JOIN mit WHERE HOEHE > 6000', sols: ['SELECT DISTINCT l.L_NAME FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME WHERE b.HOEHE > 6000', 'SELECT DISTINCT l.L_NAME FROM BERG b JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME JOIN LAND l ON gb.L_ID = l.L_ID WHERE b.HOEHE > 6000'] },
            { id: 'n3-3', n: 3, title: 'Länder + Berganzahl', desc: 'Alle Länder mit Anzahl ihrer Berge?', hint: 'LEFT JOIN mit GROUP BY', sols: ['SELECT l.L_NAME, COUNT(b.B_NAME) FROM LAND l LEFT JOIN GEO_BERG gb ON l.L_ID = gb.L_ID LEFT JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME HAVING COUNT(b.B_NAME) > 0', 'SELECT l.L_NAME, COUNT(b.B_NAME) AS anzahl FROM LAND l LEFT JOIN GEO_BERG gb ON l.L_ID = gb.L_ID LEFT JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME HAVING COUNT(b.B_NAME) > 0 ORDER BY anzahl DESC'] },
            { id: 'n4-1', n: 4, title: 'Anzahl Länder >5000m', desc: 'Wie viele Länder haben Berge über 5000m?', hint: 'COUNT(DISTINCT)', sols: ['SELECT COUNT(DISTINCT l.L_ID) FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME WHERE b.HOEHE > 5000', 'SELECT COUNT(DISTINCT l.L_NAME) FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME WHERE b.HOEHE > 5000'] },
            { id: 'n4-2', n: 4, title: 'Höchster Durchschnitt', desc: 'Land mit höchster Durchschnittshöhe?', hint: 'AVG mit ORDER BY LIMIT 1', sols: ['SELECT l.L_NAME, AVG(b.HOEHE) FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME ORDER BY AVG(b.HOEHE) DESC LIMIT 1', 'SELECT l.L_NAME, ROUND(AVG(b.HOEHE), 0) AS durchschnitt FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME ORDER BY durchschnitt DESC LIMIT 1'] },
            { id: 'n4-3', n: 4, title: 'Länderstatistik', desc: 'Für jedes Land: Anzahl und Durchschnittshöhe?', hint: 'COUNT und AVG kombinieren', sols: ['SELECT l.L_NAME, COUNT(b.B_NAME), AVG(b.HOEHE) FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME', 'SELECT l.L_NAME, COUNT(b.B_NAME) AS anzahl, ROUND(AVG(b.HOEHE), 0) AS durchschnitt FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME ORDER BY durchschnitt DESC'] }
        ];
        
        function switchTab(name) {
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
        }

        function loadLocalFile(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            const statusEl = document.getElementById('db-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = `<div class="message warning">Lade lokale Datei: ${file.name}...</div>`;

            reader.onload = async function() {
                try {
                    const buffer = reader.result;
                    await initSqlJsWithBuffer(buffer, `Lokal: ${file.name}`);
                } catch(e) {
                    statusEl.innerHTML = `<div class="message error">Fehler beim Lesen der lokalen Datei: ${e.message}</div>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function initSqlJsWithBuffer(buffer, sourceName) {
            const statusEl = document.getElementById('db-status');
            
            if (buffer.byteLength < 1000) {
                 statusEl.innerHTML = `<div class="message error"><strong>Datei zu klein:</strong> '${sourceName}' ist nur ${buffer.byteLength} Bytes groß.</div>`;
                 return;
            }

            try {
                const SQL = await initSqlJs({ 
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` 
                });
                
                db = new SQL.Database(new Uint8Array(buffer));
                
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='LAND'");
                
                if (tables.length === 0) {
                    statusEl.innerHTML = `<div class="message error">Datenbank '${sourceName}' geladen, aber Tabelle 'LAND' fehlt.</div>`;
                } else {
                    const rowCount = db.exec("SELECT count(*) FROM LAND")[0].values[0][0];
                    if (rowCount === 0) {
                        statusEl.innerHTML = `<div class="message error">Datenbank '${sourceName}' geladen, aber Tabelle 'LAND' ist <strong>LEER</strong> (0 Zeilen).<br>Bitte prüfe deinen Export.</div>`;
                    } else {
                        statusEl.innerHTML = `<div class="message success">Erfolg! '${sourceName}' geladen. (${rowCount} Länder)</div>`;
                        setTimeout(() => statusEl.style.display = 'none', 3000);
                        runMain();
                    }
                }
                
                renderTasks();
                updateStats();

            } catch (err) {
                statusEl.innerHTML = `<div class="message error">SQL Fehler: ${err.message}</div>`;
            }
        }
        
        async function initDatabase() {
            const statusEl = document.getElementById('db-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<div class="message warning">Suche Datenbank...</div>';
            
            // HIER IST DER FALLBACK LINK JETZT MIT DABEI:
            const filesToCheck = ['terra.sqlite', 'terra2023.db', 'https://raw.githubusercontent.com/lkirchne/gynesa/main/informatik/q1/db/terra/terra2023.db'];
            let buffer = null;
            let loadedName = '';
            
            for (let file of filesToCheck) {
                try {
                    // Cache-Busting nur für lokale Dateien ohne 'http'
                    const url = file.startsWith('http') ? file : file + '?t=' + Date.now();
                    
                    const res = await fetch(url);
                    if (res.ok) {
                        buffer = await res.arrayBuffer();
                        loadedName = file;
                        break; 
                    }
                } catch(e) {}
            }
            
            if (!buffer) {
                statusEl.innerHTML = `<div class="message warning"><strong>Keine Datenbank gefunden.</strong><br>Konnte weder lokale Dateien noch den Fallback-Server laden. Bitte lade deine Datei oben manuell.</div>`;
                return;
            }

            const decoder = new TextDecoder("utf-8");
            const firstBytes = decoder.decode(new Uint8Array(buffer.slice(0, 50)));
            if (firstBytes.includes("git-lfs")) {
                statusEl.innerHTML = `<div class="message error"><strong>Git LFS Fehler!</strong><br>Die Datei '${loadedName}' ist nur ein Text-Link. Bitte lade sie lokal.</div>`;
                return; 
            }

            await initSqlJsWithBuffer(buffer, loadedName);
        }
        
        function norm(q) { return q.toUpperCase().replace(/\s+/g, ' ').replace(/\s*,\s*/g, ',').replace(/\s*=\s*/g, '=').replace(/\s*\(\s*/g, '(').replace(/\s*\)\s*/g, ')').trim().replace(/;$/, ''); }
        
        function check(q, sols) {
            const nq = norm(q);
            for (let s of sols) if (nq === norm(s)) return true;
            try {
                const ur = db.exec(q);
                for (let s of sols) {
                    const sr = db.exec(s);
                    if (JSON.stringify(ur) === JSON.stringify(sr)) return true;
                }
            } catch (e) {}
            return false;
        }
        
        function run(q, target, extraMsg = '') {
            const el = document.getElementById(target);
            el.innerHTML = extraMsg;
            if (!db || !q.trim()) return;
            try {
                const res = db.exec(q);
                if(target === 'main-result') document.getElementById('main-result-header').style.display = 'block';

                if (res.length === 0) {
                    el.innerHTML += '<div class="message success">Query erfolgreich ausgeführt (keine Ergebnisse).</div>';
                    return;
                }
                const r = res[0];
                let html = `<div class="result-info">${r.values.length} Ergebnisse</div>`;
                html += '<div class="table-wrapper"><table><thead><tr>';
                html += r.columns.map(c => '<th>' + c + '</th>').join('') + '</tr></thead><tbody>';
                html += r.values.map(row => '<tr>' + row.map(c => '<td>' + (c === null ? '<span style="color:#aaa">NULL</span>' : c) + '</td>').join('') + '</tr>').join('');
                html += '</tbody></table></div>';
                el.innerHTML += html;
            } catch (e) {
                el.innerHTML += '<div class="message error">SQL Fehler: ' + e.message + '</div>';
            }
        }
        
        function runMain() { run(document.getElementById('main-editor').value, 'main-result'); }
        function clearMain() { 
            document.getElementById('main-editor').value = ''; 
            document.getElementById('main-result').innerHTML = ''; 
            document.getElementById('main-result-header').style.display = 'none';
        }
        
        function renderTasks() {
            const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
            const grouped = {};
            tasks.forEach(t => { if (!grouped[t.n]) grouped[t.n] = []; grouped[t.n].push(t); });
            
            let html = '';
            Object.keys(grouped).sort().forEach(n => {
                html += '<div class="section"><h2>Niveau ' + n + '</h2>';
                grouped[n].forEach(t => {
                    const q = saved[t.id] || '';
                    const solved = q && check(q, t.sols);
                    html += `<div class="task ${solved ? 'solved' : ''}" data-id="${t.id}">
                        <div class="task-header">
                            <div class="task-title">${t.title}</div>
                            <span class="badge ${solved ? 'solved' : ''}">N${t.n} ${solved ? '✓' : ''}</span>
                        </div>
                        <div class="task-desc">${t.desc}</div>
                        <textarea id="t-${t.id}" placeholder="SELECT ...">${q}</textarea>
                        <div class="button-group">
                            <button class="btn-primary" onclick="checkTask('${t.id}')">Überprüfen</button>
                            <button onclick="runTask('${t.id}')">Nur Ausführen</button>
                            <button onclick="toggleHint('${t.id}')">Hinweis</button>
                        </div>
                        <div id="hint-${t.id}" class="hint"><strong>Tipp:</strong> ${t.hint}</div>
                        <div id="res-${t.id}"></div>
                    </div>`;
                });
                html += '</div>';
            });
            document.getElementById('tasks').innerHTML = html;
            document.getElementById('total').textContent = tasks.length;
        }
        
        function checkTask(id) {
            const task = tasks.find(t => t.id === id);
            const q = document.getElementById('t-' + id).value;
            const el = document.getElementById('res-' + id);
            
            if (!q.trim()) { 
                el.innerHTML = '<div class="message error">Bitte gib eine Query ein.</div>'; 
                return; 
            }
            
            let message = '';
            let isCorrect = check(q, task.sols);
            
            if (isCorrect) {
                message = '<div class="message success" style="margin-bottom:1rem">Richtig gelöst! ✓</div>';
                const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
                saved[id] = q;
                localStorage.setItem('terra-sql', JSON.stringify(saved));
                
                document.querySelector(`.task[data-id="${id}"]`).classList.add('solved');
                document.querySelector(`.task[data-id="${id}"] .badge`).classList.add('solved');
                document.querySelector(`.task[data-id="${id}"] .badge`).innerHTML = `N${task.n} ✓`;
                updateStats();
            } else {
                 message = '<div class="message error" style="margin-bottom:1rem">Leider nicht korrekt. Versuche es nochmal oder prüfe die Ergebnisse unten.</div>';
            }

            run(q, 'res-' + id, message);
        }
        
        function runTask(id) { 
            run(document.getElementById('t-' + id).value, 'res-' + id); 
        }
        
        function toggleHint(id) { document.getElementById('hint-' + id).classList.toggle('visible'); }
        
        function updateStats() {
            const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
            let solved = 0, maxN = 1;
            tasks.forEach(t => {
                if (saved[t.id] && check(saved[t.id], t.sols)) {
                    solved++;
                    maxN = Math.max(maxN, t.n);
                }
            });
            document.getElementById('solved').textContent = solved;
            document.getElementById('progress').textContent = Math.round(solved / tasks.length * 100) + '%';
            document.getElementById('niveau').textContent = maxN;
        }
        
        function exportSolutions() {
            const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
            let md = '# SQL Übungen\n\n**Datum:** ' + new Date().toLocaleDateString('de-DE') + '\n';
            md += '**Gelöst:** ' + document.getElementById('solved').textContent + '/' + tasks.length + '\n\n---\n\n';
            
            const grouped = {};
            tasks.forEach(t => { if (!grouped[t.n]) grouped[t.n] = []; grouped[t.n].push(t); });
            
            Object.keys(grouped).sort().forEach(n => {
                md += `## Niveau ${n}\n\n`;
                grouped[n].forEach(t => {
                    const q = saved[t.id] || '';
                    const ok = q && check(q, t.sols);
                    md += `### ${t.title} ${ok ? '✓' : ''}\n\n${t.desc}\n\n`;
                    if (q) {
                        md += '```sql\n' + q + '\n```\n\n';
                        try {
                            const r = db.exec(q);
                            if (r.length && r[0].values.length <= 10) {
                                md += '| ' + r[0].columns.join(' | ') + ' |\n';
                                md += '|' + r[0].columns.map(() => '---').join('|') + '|\n';
                                r[0].values.forEach(row => md += '| ' + row.map(v => v || 'NULL').join(' | ') + ' |\n');
                                md += '\n';
                            }
                        } catch (e) {}
                    }
                    md += '---\n\n';
                });
            });
            
            const blob = new Blob([md], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'SQL-Loesungen-' + new Date().toISOString().split('T')[0] + '.md';
            a.click();
        }
        
        function resetApp() {
            if(confirm("Bist du sicher? Dies löscht:\n1. Deinen gespeicherten Fortschritt\n2. Den Browser-Cache für diese Seite\n\nDie Seite wird danach neu geladen.")) {
                localStorage.clear();
                if('caches' in window) {
                    caches.keys().then(function(names) {
                        for (let name of names) caches.delete(name);
                    });
                }
                const url = new URL(window.location.href);
                url.searchParams.set('reloadTime', Date.now());
                window.location.href = url.toString();
            }
        }

        initDatabase();
    </script>
</body>
</html>
