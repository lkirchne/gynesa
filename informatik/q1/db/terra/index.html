<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Übungen - Terra Datenbank</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        :root {
            --bg-body: #fdfcfc;
            --bg-surface: #ffffff;
            --text-main: #334155;
            --text-muted: #64748b;
            --primary: #7dd3fc;
            --primary-dark: #0ea5e9;
            --primary-bg: #f0f9ff;
            --border-color: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --success-bg: #dcfce7;
            --success-text: #166534;
            --error-bg: #fee2e2;
            --error-text: #991b1b;
            --code-font: 'Source Code Pro', monospace;
            --body-font: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--body-font);
            background: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
        }
        
        .header {
            background: var(--bg-surface);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        h1 { font-size: 1.5rem; font-weight: 600; color: #1e293b; }
        .subtitle { color: var(--text-muted); font-size: 0.9rem; margin-top: 0.25rem; }
        .container { max-width: 1000px; margin: 0 auto; padding: 2rem 1rem; }
        
        /* Debug / Status Bar */
        #db-status { margin-bottom: 1.5rem; display: none; }
        
        .stats {
            display: flex; gap: 2rem; margin-bottom: 2rem;
            font-size: 0.9rem; color: var(--text-muted);
            background: var(--bg-surface); padding: 1rem 1.5rem;
            border-radius: 12px; box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .stats span { font-weight: 600; color: var(--text-main); }
        
        nav { display: flex; gap: 0.5rem; margin-bottom: 2rem; overflow-x: auto; }
        
        nav button {
            background: transparent; border: none; padding: 0.75rem 1.25rem;
            font-size: 0.95rem; color: var(--text-muted); cursor: pointer;
            border-radius: 8px; font-weight: 500; transition: all 0.2s;
        }
        nav button:hover { background: #f1f5f9; color: var(--text-main); }
        nav button.active { background: var(--primary-bg); color: var(--primary-dark); font-weight: 600; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .section {
            background: var(--bg-surface); padding: 2rem; margin-bottom: 1.5rem;
            border-radius: 16px; box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        
        h2 { font-size: 1.25rem; margin-bottom: 1.25rem; font-weight: 600; color: #1e293b; }
        h3 { font-size: 1rem; margin: 1.5rem 0 0.75rem 0; font-weight: 600; color: #475569; text-transform: uppercase; }
        
        textarea {
            width: 100%; min-height: 120px; padding: 1rem;
            font-family: var(--code-font); font-size: 0.9rem;
            border: 2px solid var(--border-color); border-radius: 8px;
            background: #f8fafc; resize: vertical; color: #334155;
        }
        textarea:focus { outline: none; border-color: var(--primary); background: #fff; }
        
        .button-group { display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
        
        button {
            padding: 0.6rem 1.2rem; font-size: 0.9rem; background: #fff;
            border: 1px solid #cbd5e1; cursor: pointer; border-radius: 6px;
            font-weight: 500; color: #475569; transition: all 0.2s;
        }
        button:hover { background: #f8fafc; }
        .btn-primary { background: #3b82f6; color: #fff; border: none; }
        .btn-primary:hover { background: #2563eb; }
        
        .table-wrapper { width: 100%; overflow-x: auto; border-radius: 8px; border: 1px solid var(--border-color); margin-top: 1rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 600px; }
        th { text-align: left; padding: 0.85rem 1rem; background: #f1f5f9; position: sticky; top: 0; }
        td { padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        tr:nth-child(even) { background-color: #fafbfc; }
        
        .message { padding: 1rem; margin-top: 1rem; border-radius: 8px; font-size: 0.9rem; }
        .success { background: var(--success-bg); color: var(--success-text); }
        .error { background: var(--error-bg); color: var(--error-text); border: 1px solid #fca5a5; }
        
        .task { border: 1px solid var(--border-color); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 12px; }
        .task.solved { background: #f0fdf4; border-color: #bbf7d0; }
        
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .task-title { font-weight: 600; color: #1e293b; }
        .badge { font-size: 0.75rem; padding: 0.25rem 0.75rem; background: #f1f5f9; border-radius: 999px; }
        .badge.solved { background: #dcfce7; color: #15803d; }
        
        .hint { background: #fffbeb; padding: 1rem; margin-top: 1rem; display: none; border-radius: 8px; color: #92400e; }
        .hint.visible { display: block; }
        
        .help-block { background: #f8fafc; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; }
        .help-block code { display: block; font-family: var(--code-font); background: #fff; padding: 0.75rem; border-radius: 6px; white-space: pre; overflow-x: auto; }
        
        code.inline { font-family: var(--code-font); background: #f1f5f9; padding: 0.1rem 0.3rem; border-radius: 4px; }
        .result-info { font-size: 0.8rem; color: var(--text-muted); margin: 0.5rem 0; text-align: right; }
    </style>
</head>
<body>
    <div class="header">
        <h1>SQL Übungen - Terra Datenbank</h1>
        <p class="subtitle">Aggregationsfunktionen & JOINs</p>
    </div>
    
    <div class="container">
        <!-- Debug Area -->
        <div id="db-status"></div>

        <div class="stats">
            <div>Gelöst: <span id="solved">0</span>/<span id="total">0</span></div>
            <div>Fortschritt: <span id="progress">0%</span></div>
            <div>Niveau: <span id="niveau">1</span></div>
        </div>
        
        <nav>
            <button class="active" onclick="switchTab('editor')">Freier Editor</button>
            <button onclick="switchTab('tasks')">Aufgaben</button>
            <button onclick="switchTab('database')">Datenbank Struktur</button>
            <button onclick="switchTab('help')">Cheat Sheet</button>
        </nav>
        
        <div id="tab-editor" class="tab-content active">
            <div class="section">
                <h2>SQL Playground</h2>
                <textarea id="main-editor" placeholder="SELECT * FROM BERG LIMIT 10;">SELECT * FROM LAND LIMIT 10;</textarea>
                <div class="button-group">
                    <button class="btn-primary" onclick="runMain()">Abfrage Ausführen</button>
                    <button onclick="clearMain()">Leeren</button>
                </div>
                <div id="main-result"></div>
            </div>
        </div>
        
        <div id="tab-tasks" class="tab-content">
            <div id="tasks"></div>
            <div class="section">
                <h2>Lösungen Speichern</h2>
                <button class="btn-primary" onclick="exportSolutions()">Lösungen herunterladen</button>
            </div>
        </div>
        
        <div id="tab-database" class="tab-content">
            <div class="section">
                <h2>Datenbank-Übersicht</h2>
                <h3>Haupttabellen</h3>
                <div class="help-block"><h4>BERG</h4><code>B_NAME, GEBIRGE, HOEHE, JAHR, LAENGE, BREITE</code></div>
                <div class="help-block"><h4>LAND</h4><code>L_ID, L_NAME, EINWOHNER, FLAECHE, HAUPTSTADT, LT_ID</code></div>
                <div class="help-block"><h4>FLUSS</h4><code>F_NAME, FLUSS, SEE, MEER, LAENGE</code></div>
                <div class="help-block"><h4>STADT</h4><code>ST_NAME, L_ID, EINWOHNER, BREITE, LAENGE</code></div>
                <h3>Verbindungstabellen</h3>
                <div class="help-block"><h4>GEO_BERG, GEO_FLUSS, UMFASST</h4></div>
            </div>
        </div>
        
        <div id="tab-help" class="tab-content">
            <div class="section">
                <h2>SQL Referenz</h2>
                <div class="help-block"><h4>Aggregation</h4><code>SELECT COUNT(*) FROM LAND;</code></div>
                <div class="help-block"><h4>JOIN</h4><code>SELECT * FROM BERG b JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME;</code></div>
            </div>
        </div>
    </div>
    
    <script>
        let db = null;
        
        // --- KEINE DEMO DATEN MEHR ---
        // Wenn es fehlschlägt, dann schlägt es fehl und wir zeigen warum.

        const tasks = [
            { id: 'n1-1', n: 1, title: 'Anzahl Länder', desc: 'Wie viele Länder gibt es in der Datenbank?', hint: 'COUNT(*) auf LAND', sols: ['SELECT COUNT(*) FROM LAND', 'SELECT COUNT(*) AS anzahl FROM LAND', 'SELECT COUNT(L_ID) FROM LAND'] },
            { id: 'n1-2', n: 1, title: 'Größtes Land', desc: 'Wie groß ist das größte Land (nach Fläche)?', hint: 'ORDER BY FLAECHE DESC LIMIT 1 oder MAX()', sols: ['SELECT L_NAME, FLAECHE FROM LAND ORDER BY FLAECHE DESC LIMIT 1', 'SELECT L_NAME, MAX(FLAECHE) FROM LAND', 'SELECT L_NAME, FLAECHE FROM LAND WHERE FLAECHE = (SELECT MAX(FLAECHE) FROM LAND)'] },
            { id: 'n1-3', n: 1, title: 'Bevölkerungsreichstes Land', desc: 'Wie viele Einwohner hat das bevölkerungsreichste Land?', hint: 'MAX(EINWOHNER)', sols: ['SELECT MAX(EINWOHNER) FROM LAND', 'SELECT L_NAME, EINWOHNER FROM LAND ORDER BY EINWOHNER DESC LIMIT 1', 'SELECT EINWOHNER FROM LAND WHERE EINWOHNER = (SELECT MAX(EINWOHNER) FROM LAND)'] },
            { id: 'n1-4', n: 1, title: 'Längster Fluss', desc: 'Wie lang ist der längste Fluss?', hint: 'MAX(LAENGE) auf FLUSS', sols: ['SELECT MAX(LAENGE) FROM FLUSS', 'SELECT F_NAME, LAENGE FROM FLUSS ORDER BY LAENGE DESC LIMIT 1', 'SELECT LAENGE FROM FLUSS WHERE LAENGE = (SELECT MAX(LAENGE) FROM FLUSS)'] },
            { id: 'n1-5', n: 1, title: 'Anzahl Gebirge', desc: 'Wie viele verschiedene Gebirge gibt es?', hint: 'COUNT(DISTINCT GEBIRGE)', sols: ['SELECT COUNT(DISTINCT GEBIRGE) FROM BERG', 'SELECT COUNT(DISTINCT GEBIRGE) AS anzahl FROM BERG'] },
            { id: 'n1-6', n: 1, title: 'Durchschnittliche Berghöhe', desc: 'Durchschnittliche Höhe aller Berge?', hint: 'AVG(HOEHE)', sols: ['SELECT AVG(HOEHE) FROM BERG', 'SELECT AVG(HOEHE) AS durchschnitt FROM BERG', 'SELECT ROUND(AVG(HOEHE), 0) FROM BERG'] },
            { id: 'n2-1', n: 2, title: 'Berge pro Gebirge', desc: 'Wie viele Berge pro Gebirge? (sortiert)', hint: 'GROUP BY GEBIRGE', sols: ['SELECT GEBIRGE, COUNT(*) FROM BERG GROUP BY GEBIRGE ORDER BY COUNT(*) DESC', 'SELECT GEBIRGE, COUNT(*) AS anzahl FROM BERG GROUP BY GEBIRGE ORDER BY anzahl DESC'] },
            { id: 'n2-2', n: 2, title: 'Gebirge mit >10 Bergen', desc: 'Welche Gebirge haben mehr als 10 Berge?', hint: 'HAVING COUNT(*) > 10', sols: ['SELECT GEBIRGE, COUNT(*) FROM BERG GROUP BY GEBIRGE HAVING COUNT(*) > 10', 'SELECT GEBIRGE, COUNT(*) AS anzahl FROM BERG GROUP BY GEBIRGE HAVING COUNT(*) > 10'] },
            { id: 'n2-3', n: 2, title: 'Durchschnitt pro Gebirge', desc: 'Durchschnittliche Höhe pro Gebirge?', hint: 'AVG(HOEHE) mit GROUP BY', sols: ['SELECT GEBIRGE, AVG(HOEHE) FROM BERG GROUP BY GEBIRGE', 'SELECT GEBIRGE, ROUND(AVG(HOEHE), 0) FROM BERG GROUP BY GEBIRGE', 'SELECT GEBIRGE, AVG(HOEHE) AS durchschnitt FROM BERG GROUP BY GEBIRGE ORDER BY durchschnitt DESC'] },
            { id: 'n2-4', n: 2, title: 'Max/Min pro Gebirge', desc: 'Höchster und niedrigster Berg pro Gebirge?', hint: 'MAX() und MIN() mit GROUP BY', sols: ['SELECT GEBIRGE, MAX(HOEHE), MIN(HOEHE) FROM BERG GROUP BY GEBIRGE', 'SELECT GEBIRGE, MAX(HOEHE) AS hoechster, MIN(HOEHE) AS niedrigster FROM BERG GROUP BY GEBIRGE'] },
            { id: 'n3-1', n: 3, title: 'Top 10 Berge + Länder', desc: 'Die 10 höchsten Berge mit ihren Ländern?', hint: 'JOIN über 3 Tabellen', sols: ['SELECT b.B_NAME, b.HOEHE, l.L_NAME FROM BERG b JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME JOIN LAND l ON gb.L_ID = l.L_ID ORDER BY b.HOEHE DESC LIMIT 10', 'SELECT b.B_NAME, b.HOEHE, l.L_NAME FROM BERG b INNER JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME INNER JOIN LAND l ON gb.L_ID = l.L_ID ORDER BY b.HOEHE DESC LIMIT 10'] },
            { id: 'n3-2', n: 3, title: 'Länder >6000m', desc: 'Welche Länder haben Berge über 6000m?', hint: 'JOIN mit WHERE HOEHE > 6000', sols: ['SELECT DISTINCT l.L_NAME FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME WHERE b.HOEHE > 6000', 'SELECT DISTINCT l.L_NAME FROM BERG b JOIN GEO_BERG gb ON b.B_NAME = gb.B_NAME JOIN LAND l ON gb.L_ID = l.L_ID WHERE b.HOEHE > 6000'] },
            { id: 'n3-3', n: 3, title: 'Länder + Berganzahl', desc: 'Alle Länder mit Anzahl ihrer Berge?', hint: 'LEFT JOIN mit GROUP BY', sols: ['SELECT l.L_NAME, COUNT(b.B_NAME) FROM LAND l LEFT JOIN GEO_BERG gb ON l.L_ID = gb.L_ID LEFT JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME HAVING COUNT(b.B_NAME) > 0', 'SELECT l.L_NAME, COUNT(b.B_NAME) AS anzahl FROM LAND l LEFT JOIN GEO_BERG gb ON l.L_ID = gb.L_ID LEFT JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME HAVING COUNT(b.B_NAME) > 0 ORDER BY anzahl DESC'] },
            { id: 'n4-1', n: 4, title: 'Anzahl Länder >5000m', desc: 'Wie viele Länder haben Berge über 5000m?', hint: 'COUNT(DISTINCT)', sols: ['SELECT COUNT(DISTINCT l.L_ID) FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME WHERE b.HOEHE > 5000', 'SELECT COUNT(DISTINCT l.L_NAME) FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME WHERE b.HOEHE > 5000'] },
            { id: 'n4-2', n: 4, title: 'Höchster Durchschnitt', desc: 'Land mit höchster Durchschnittshöhe?', hint: 'AVG mit ORDER BY LIMIT 1', sols: ['SELECT l.L_NAME, AVG(b.HOEHE) FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME ORDER BY AVG(b.HOEHE) DESC LIMIT 1', 'SELECT l.L_NAME, ROUND(AVG(b.HOEHE), 0) AS durchschnitt FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME ORDER BY durchschnitt DESC LIMIT 1'] },
            { id: 'n4-3', n: 4, title: 'Länderstatistik', desc: 'Für jedes Land: Anzahl und Durchschnittshöhe?', hint: 'COUNT und AVG kombinieren', sols: ['SELECT l.L_NAME, COUNT(b.B_NAME), AVG(b.HOEHE) FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME', 'SELECT l.L_NAME, COUNT(b.B_NAME) AS anzahl, ROUND(AVG(b.HOEHE), 0) AS durchschnitt FROM LAND l JOIN GEO_BERG gb ON l.L_ID = gb.L_ID JOIN BERG b ON gb.B_NAME = b.B_NAME GROUP BY l.L_NAME ORDER BY durchschnitt DESC'] }
        ];

        function switchTab(name) {
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
        }
        
        async function initDatabase() {
            const statusEl = document.getElementById('db-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<div class="message">Lade Datenbank terra.db...</div>';
            
            try {
                // 1. Fetch File
                // Cache-Busting um sicherzugehen, dass wir nicht die alte kaputte Version laden
                const response = await fetch('terra.db?t=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`Netzwerkfehler: ${response.status} ${response.statusText}`);
                }
                
                const buffer = await response.arrayBuffer();
                
                // 2. DIAGNOSE: Ist es ein Git LFS Pointer?
                // Wir schauen uns die ersten 50 Bytes als Text an.
                const decoder = new TextDecoder("utf-8");
                const firstBytes = decoder.decode(new Uint8Array(buffer.slice(0, 50)));
                
                console.log("File size:", buffer.byteLength);
                console.log("File start:", firstBytes);
                
                if (firstBytes.includes("git-lfs")) {
                    statusEl.innerHTML = `
                        <div class="message error">
                            <h3>⚠️ Git LFS Fehler erkannt!</h3>
                            <p>Die Datei 'terra.db' wurde nicht korrekt heruntergeladen. GitHub Pages liefert statt der Datenbank nur einen Text-Hinweis (Pointer) aus.</p>
                            <p><strong>Inhalt der Datei:</strong> ${firstBytes}...</p>
                            <p><strong>Lösung:</strong> Du musst Git LFS für diese Datei deaktivieren oder die Datei ohne LFS hochladen.</p>
                        </div>`;
                    return; // Abbruch
                }
                
                if (buffer.byteLength < 1000) {
                     statusEl.innerHTML = `
                        <div class="message error">
                            <h3>⚠️ Datei zu klein</h3>
                            <p>Die geladene Datei ist nur ${buffer.byteLength} Bytes groß. Das ist keine gültige SQLite Datenbank.</p>
                        </div>`;
                    return;
                }

                // 3. Init SQL.js
                const SQL = await initSqlJs({ 
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` 
                });
                
                db = new SQL.Database(new Uint8Array(buffer));
                
                // 4. Test Query
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='LAND'");
                if (tables.length === 0) {
                    statusEl.innerHTML = `<div class="message error">Datenbank geladen, aber Tabelle 'LAND' fehlt. Ist die Datei leer?</div>`;
                } else {
                    const rowCount = db.exec("SELECT count(*) FROM LAND")[0].values[0][0];
                    statusEl.innerHTML = `<div class="message success">Datenbank erfolgreich geladen! (${rowCount} Länder gefunden)</div>`;
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                    runMain(); // Erste Abfrage ausführen
                }
                
                renderTasks();
                updateStats();

            } catch (err) {
                statusEl.innerHTML = `<div class="message error">Fehler: ${err.message}</div>`;
                console.error(err);
            }
        }
        
        function norm(q) { return q.toUpperCase().replace(/\s+/g, ' ').replace(/\s*,\s*/g, ',').replace(/\s*=\s*/g, '=').replace(/\s*\(\s*/g, '(').replace(/\s*\)\s*/g, ')').trim().replace(/;$/, ''); }
        
        function check(q, sols) {
            if (!db) return false;
            const nq = norm(q);
            for (let s of sols) if (nq === norm(s)) return true;
            try {
                const ur = db.exec(q);
                for (let s of sols) {
                    const sr = db.exec(s);
                    if (JSON.stringify(ur) === JSON.stringify(sr)) return true;
                }
            } catch (e) {}
            return false;
        }
        
        function run(q, target) {
            const el = document.getElementById(target);
            el.innerHTML = '';
            if (!db) {
                el.innerHTML = '<div class="message error">Datenbank nicht geladen. Siehe Status oben.</div>';
                return;
            }
            if (!q.trim()) return;
            
            try {
                const res = db.exec(q);
                if (res.length === 0) {
                    el.innerHTML = '<div class="message success">Erfolgreich ausgeführt (Keine Ergebnisse).</div>';
                    return;
                }
                const r = res[0];
                let html = `<div class="result-info">${r.values.length} Ergebnisse</div>`;
                html += '<div class="table-wrapper"><table><thead><tr>';
                html += r.columns.map(c => '<th>' + c + '</th>').join('') + '</tr></thead><tbody>';
                html += r.values.map(row => '<tr>' + row.map(c => '<td>' + (c === null ? '<span style="color:#aaa">NULL</span>' : c) + '</td>').join('') + '</tr>').join('');
                html += '</tbody></table></div>';
                el.innerHTML = html;
            } catch (e) {
                el.innerHTML = '<div class="message error">SQL Fehler: ' + e.message + '</div>';
            }
        }
        
        function runMain() { run(document.getElementById('main-editor').value, 'main-result'); }
        function clearMain() { document.getElementById('main-editor').value = ''; document.getElementById('main-result').innerHTML = ''; }
        
        function renderTasks() {
            const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
            const grouped = {};
            tasks.forEach(t => { if (!grouped[t.n]) grouped[t.n] = []; grouped[t.n].push(t); });
            
            let html = '';
            Object.keys(grouped).sort().forEach(n => {
                html += '<div class="section"><h2>Niveau ' + n + '</h2>';
                grouped[n].forEach(t => {
                    const q = saved[t.id] || '';
                    const solved = q && check(q, t.sols);
                    html += `<div class="task ${solved ? 'solved' : ''}" data-id="${t.id}">
                        <div class="task-header">
                            <div class="task-title">${t.title}</div>
                            <span class="badge ${solved ? 'solved' : ''}">N${t.n} ${solved ? '✓' : ''}</span>
                        </div>
                        <div class="task-desc">${t.desc}</div>
                        <textarea id="t-${t.id}" placeholder="SELECT ...">${q}</textarea>
                        <div class="button-group">
                            <button class="btn-primary" onclick="checkTask('${t.id}')">Überprüfen</button>
                            <button onclick="runTask('${t.id}')">Nur Ausführen</button>
                            <button onclick="toggleHint('${t.id}')">Hinweis</button>
                        </div>
                        <div id="hint-${t.id}" class="hint"><strong>Tipp:</strong> ${t.hint}</div>
                        <div id="res-${t.id}"></div>
                    </div>`;
                });
                html += '</div>';
            });
            document.getElementById('tasks').innerHTML = html;
            document.getElementById('total').textContent = tasks.length;
        }
        
        function checkTask(id) {
            const task = tasks.find(t => t.id === id);
            const q = document.getElementById('t-' + id).value;
            const el = document.getElementById('res-' + id);
            
            if (!q.trim()) { el.innerHTML = '<div class="message error">Bitte Query eingeben.</div>'; return; }
            
            const isCorrect = check(q, task.sols);
            if (isCorrect) {
                el.innerHTML = '<div class="message success">Richtig gelöst! ✓</div>';
                const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
                saved[id] = q;
                localStorage.setItem('terra-sql', JSON.stringify(saved));
                
                document.querySelector(`.task[data-id="${id}"]`).classList.add('solved');
                document.querySelector(`.task[data-id="${id}"] .badge`).classList.add('solved');
                document.querySelector(`.task[data-id="${id}"] .badge`).innerHTML = `N${task.n} ✓`;
                updateStats();
            } else {
                el.innerHTML = '<div class="message error">Leider nicht korrekt.</div>';
            }
            // Zeige immer das Ergebnis der Query an
            const tempDiv = document.createElement('div');
            tempDiv.id = 'temp-res-' + id;
            el.appendChild(tempDiv);
            run(q, tempDiv.id);
        }
        
        function runTask(id) { run(document.getElementById('t-' + id).value, 'res-' + id); }
        function toggleHint(id) { document.getElementById('hint-' + id).classList.toggle('visible'); }
        
        function updateStats() {
            const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
            let solved = 0, maxN = 1;
            tasks.forEach(t => {
                if (saved[t.id] && check(saved[t.id], t.sols)) {
                    solved++;
                    maxN = Math.max(maxN, t.n);
                }
            });
            document.getElementById('solved').textContent = solved;
            document.getElementById('progress').textContent = Math.round(solved / tasks.length * 100) + '%';
            document.getElementById('niveau').textContent = maxN;
        }
        
        function exportSolutions() {
            const saved = JSON.parse(localStorage.getItem('terra-sql') || '{}');
            let md = '# SQL Lösungen\n\n';
            tasks.forEach(t => {
                const q = saved[t.id];
                if(q) md += `### ${t.title}\n\`\`\`sql\n${q}\n\`\`\`\n\n`;
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([md], {type: 'text/markdown'}));
            a.download = 'Loesungen.md';
            a.click();
        }
        
        initDatabase();
    </script>
</body>
</html>
